# å¤šçº¿ç¨‹æ ¸å¿ƒçŸ¥è¯†é€ŸæŸ¥æ‰‹å†Œ

> **5åˆ†é’Ÿå¿«é€Ÿä¸Šæ‰‹ | 30åˆ†é’Ÿæ·±å…¥ç†è§£ | åŸºäºçœŸå®ç”Ÿäº§é¡¹ç›®**

---

## ğŸ“Œ å¿«é€Ÿå¯¼èˆª

**æ–°æ‰‹ï¼ˆ5åˆ†é’Ÿï¼‰**ï¼šçœ‹ [ä¸€ã€å¿«é€Ÿä¸Šæ‰‹](#ä¸€å¿«é€Ÿä¸Šæ‰‹)  
**è¿›é˜¶ï¼ˆ30åˆ†é’Ÿï¼‰**ï¼šçœ‹ [äºŒã€æ ¸å¿ƒåŸç†](#äºŒæ ¸å¿ƒåŸç†) + [ä¸‰ã€ç”Ÿäº§å®è·µ](#ä¸‰ç”Ÿäº§å®è·µ)  
**é¢è¯•ï¼ˆ1å°æ—¶ï¼‰**ï¼šçœ‹ [å››ã€é«˜é¢‘é¢è¯•é¢˜](#å››é«˜é¢‘é¢è¯•é¢˜) + [äº”ã€è¸©å‘è®°å½•](#äº”è¸©å‘è®°å½•)

---

## ä¸€ã€å¿«é€Ÿä¸Šæ‰‹ï¼ˆ5åˆ†é’Ÿï¼‰

### 1.1 çº¿ç¨‹æ± æ˜¯ä»€ä¹ˆï¼Ÿ

**ä¸€å¥è¯ï¼š** å¤ç”¨çº¿ç¨‹ï¼Œé¿å…é¢‘ç¹åˆ›å»ºé”€æ¯çº¿ç¨‹çš„å¼€é”€ã€‚

**ç±»æ¯”ï¼š** 
- ä¸ç”¨çº¿ç¨‹æ±  = æ¯æ¬¡æ‰“è½¦éƒ½ä¹°ä¸€è¾†æ–°è½¦
- ç”¨çº¿ç¨‹æ±  = æ»´æ»´æ‰“è½¦ï¼ˆè½¦è¾†å¤ç”¨ï¼‰

### 1.2 æœ€ç®€å•çš„ä¾‹å­

```java
// âŒ é”™è¯¯ï¼šæ¯æ¬¡éƒ½åˆ›å»ºæ–°çº¿ç¨‹
new Thread(() -> System.out.println("Hello")).start();

// âœ… æ­£ç¡®ï¼šä½¿ç”¨çº¿ç¨‹æ± 
ExecutorService executor = Executors.newFixedThreadPool(10);
executor.execute(() -> System.out.println("Hello"));
```

### 1.3 é¡¹ç›®ä¸­æ€ä¹ˆç”¨ï¼Ÿ

```java
// 1. é…ç½®çº¿ç¨‹æ± 
@Bean
public Executor taskExecutor() {
    ThreadPoolExecutor executor = new ThreadPoolExecutor(
        8,                              // æ ¸å¿ƒçº¿ç¨‹æ•°
        16,                             // æœ€å¤§çº¿ç¨‹æ•°
        60L, TimeUnit.SECONDS,          // ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´
        new LinkedBlockingQueue<>(500), // é˜Ÿåˆ—å®¹é‡
        new ThreadPoolExecutor.CallerRunsPolicy() // æ‹’ç»ç­–ç•¥
    );
    return executor;
}

// 2. ä½¿ç”¨çº¿ç¨‹æ± 
@Async("taskExecutor")
public void sendEmail(String email) {
    // å¼‚æ­¥å‘é€é‚®ä»¶
}
```

**å°±è¿™ä¹ˆç®€å•ï¼** 90% çš„åœºæ™¯ç”¨è¿™ä¸ªé…ç½®å°±å¤Ÿäº†ã€‚

---

## äºŒã€æ ¸å¿ƒåŸç†ï¼ˆ30åˆ†é’Ÿï¼‰

### 2.1 çº¿ç¨‹æ± æ‰§è¡Œæµç¨‹

```text
æäº¤ä»»åŠ¡
  â†“
å½“å‰çº¿ç¨‹æ•° < æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Ÿ
  â”œâ”€ æ˜¯ â†’ åˆ›å»ºæ–°çº¿ç¨‹
  â””â”€ å¦ â†’ é˜Ÿåˆ—æœªæ»¡ï¼Ÿ
           â”œâ”€ æ˜¯ â†’ ä»»åŠ¡å…¥é˜Ÿ
           â””â”€ å¦ â†’ å½“å‰çº¿ç¨‹æ•° < æœ€å¤§çº¿ç¨‹æ•°ï¼Ÿ
                    â”œâ”€ æ˜¯ â†’ åˆ›å»ºæ–°çº¿ç¨‹
                    â””â”€ å¦ â†’ æ‰§è¡Œæ‹’ç»ç­–ç•¥
```

**å…³é”®é—®é¢˜ï¼šä¸ºä»€ä¹ˆè¦å…ˆå…¥é˜Ÿï¼Œå†åˆ›å»ºçº¿ç¨‹ï¼Ÿ**

ç­”ï¼š**æ€§èƒ½ä¼˜åŒ–**ã€‚åˆ›å»ºçº¿ç¨‹æœ‰å¼€é”€ï¼Œèƒ½å¤ç”¨å°±å¤ç”¨ã€‚

### 2.2 æ ¸å¿ƒå‚æ•°å¦‚ä½•è®¾ç½®ï¼Ÿ

| ä»»åŠ¡ç±»å‹ | æ ¸å¿ƒçº¿ç¨‹æ•° | æœ€å¤§çº¿ç¨‹æ•° | é˜Ÿåˆ— | åŸå›  |
|---------|-----------|-----------|------|------|
| **CPUå¯†é›†å‹** | N + 1 | N + 1 | å°é˜Ÿåˆ— | CPUè·‘æ»¡ï¼Œå¤šçº¿ç¨‹æ— ç”¨ |
| **IOå¯†é›†å‹** | 2N ~ 4N | 2N ~ 4N | å¤§é˜Ÿåˆ— | IOç­‰å¾…æ—¶é—´é•¿ï¼Œå¤šçº¿ç¨‹æé«˜åå |
| **æ··åˆå‹** | æµ‹è¯•å†³å®š | æµ‹è¯•å†³å®š | ä¸­ç­‰é˜Ÿåˆ— | æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ |

**é¡¹ç›®å®è·µï¼ˆIOå¯†é›†å‹ï¼‰ï¼š**
```java
// ä¸šåŠ¡ï¼šæ•°æ®åº“æŸ¥è¯¢å 80%ï¼ŒIOç­‰å¾…æ—¶é—´é•¿
// æµ‹è¯•æ•°æ®ï¼š
// - CPUÃ—2: QPS=400, RT=250ms
// - CPUÃ—4: QPS=700, RT=180ms
// - CPUÃ—8: QPS=850, RT=150ms âœ… æ€§ä»·æ¯”æœ€é«˜
// - CPUÃ—16: QPS=900, RT=160msï¼ˆæå‡ä¸æ˜æ˜¾ï¼‰

int coreSize = Runtime.getRuntime().availableProcessors() * 8;  // 8æ ¸ Ã— 8 = 64
int maxSize = Runtime.getRuntime().availableProcessors() * 16; // 8æ ¸ Ã— 16 = 128
```

**å…³é”®ï¼šä¸€å®šè¦æµ‹è¯•ï¼ä¸è¦æ‹è„‘è¢‹ï¼**

### 2.3 å››ç§æ‹’ç»ç­–ç•¥

| ç­–ç•¥ | è¡Œä¸º | é€‚ç”¨åœºæ™¯ | é¡¹ç›®å®è·µ |
|------|------|---------|---------|
| **AbortPolicy** | æŠ›å¼‚å¸¸ | ä¸å…è®¸ä¸¢å¤±ä»»åŠ¡ | âŒ æœªä½¿ç”¨ |
| **CallerRunsPolicy** | è°ƒç”¨è€…æ‰§è¡Œ | å‰Šå³°å¡«è°· | âœ… é»˜è®¤ç­–ç•¥ |
| **DiscardPolicy** | ç›´æ¥ä¸¢å¼ƒ | å…è®¸ä¸¢å¤±ä»»åŠ¡ | âŒ æœªä½¿ç”¨ |
| **DiscardOldestPolicy** | ä¸¢å¼ƒæœ€è€çš„ | ä¼˜å…ˆå¤„ç†æ–°ä»»åŠ¡ | âŒ æœªä½¿ç”¨ |

**ä¸ºä»€ä¹ˆé€‰ CallerRunsPolicyï¼Ÿ**
- ä¸ä¸¢å¤±ä»»åŠ¡
- è‡ªåŠ¨é™é€Ÿï¼ˆè°ƒç”¨è€…çº¿ç¨‹æ‰§è¡Œï¼Œæ— æ³•ç»§ç»­æäº¤æ–°ä»»åŠ¡ï¼‰
- ç”Ÿäº§ç¯å¢ƒæœ€å¸¸ç”¨

---

## ä¸‰ã€ç”Ÿäº§å®è·µï¼ˆ30åˆ†é’Ÿï¼‰

### 3.1 çœŸå®æ¡ˆä¾‹ï¼š5ä¸ªæ•°æ®æºå¹¶è¡ŒæŸ¥è¯¢

**åœºæ™¯ï¼š** çº¿ç´¢è¯¦æƒ…é¡µéœ€è¦æŸ¥è¯¢5ä¸ªæ•°æ®æºï¼Œä¸²è¡Œè€—æ—¶1000msã€‚

**ä¼˜åŒ–å‰ï¼š**
```java
// ä¸²è¡ŒæŸ¥è¯¢ï¼š1000ms
ClueInfo clue = clueService.getClue(id);           // 200ms
ReviewInfo review = reviewService.getReview(id);   // 200ms
CustInfo cust = custService.getCust(id);           // 200ms
UserInfo user = userService.getUser(id);           // 200ms
RemarkInfo remark = remarkService.getRemark(id);   // 200ms
```

**ä¼˜åŒ–åï¼š**
```java
// å¹¶è¡ŒæŸ¥è¯¢ï¼š200msï¼ˆæ€§èƒ½æå‡5å€ï¼‰
CompletableFuture<ClueInfo> f1 = CompletableFuture.supplyAsync(() -> clueService.getClue(id), executor);
CompletableFuture<ReviewInfo> f2 = CompletableFuture.supplyAsync(() -> reviewService.getReview(id), executor);
CompletableFuture<CustInfo> f3 = CompletableFuture.supplyAsync(() -> custService.getCust(id), executor);
CompletableFuture<UserInfo> f4 = CompletableFuture.supplyAsync(() -> userService.getUser(id), executor);
CompletableFuture<RemarkInfo> f5 = CompletableFuture.supplyAsync(() -> remarkService.getRemark(id), executor);

CompletableFuture.allOf(f1, f2, f3, f4, f5).join();

ClueInfo clue = f1.get();
ReviewInfo review = f2.get();
// ...
```

**å…³é”®æ•°æ®ï¼š**
- ä¼˜åŒ–å‰ï¼šQPS=100, RT=1000ms
- ä¼˜åŒ–åï¼šQPS=500, RT=200ms
- **æ€§èƒ½æå‡ï¼š5å€**

### 3.2 çœŸå®æ¡ˆä¾‹ï¼šThreadLocal ä¸Šä¸‹æ–‡ä¼ é€’

**é—®é¢˜ï¼š** çº¿ç¨‹æ± ä¸­æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯ã€‚

```java
// ä¸»çº¿ç¨‹
UserContext.set(user);

// å­çº¿ç¨‹ï¼ˆçº¿ç¨‹æ± ï¼‰
@Async
public void sendEmail() {
    User user = UserContext.get(); // âŒ nullï¼
}
```

**åŸå› ï¼š** ThreadLocal æ˜¯çº¿ç¨‹éš”ç¦»çš„ï¼Œå­çº¿ç¨‹æ— æ³•è®¿é—®çˆ¶çº¿ç¨‹çš„æ•°æ®ã€‚

**è§£å†³æ–¹æ¡ˆï¼š** ä½¿ç”¨ TransmittableThreadLocalï¼ˆé˜¿é‡Œå¼€æºï¼‰

```java
// 1. å¼•å…¥ä¾èµ–
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>transmittable-thread-local</artifactId>
    <version>2.14.2</version>
</dependency>

// 2. æ›¿æ¢ ThreadLocal
private static final TransmittableThreadLocal<User> USER_CONTEXT = new TransmittableThreadLocal<>();

// 3. åŒ…è£…çº¿ç¨‹æ± 
Executor ttlExecutor = TtlExecutors.getTtlExecutor(executor);

// 4. ä½¿ç”¨
UserContext.set(user);

@Async("ttlExecutor")
public void sendEmail() {
    User user = UserContext.get(); // âœ… æ­£å¸¸è·å–
}
```

---

## å››ã€é«˜é¢‘é¢è¯•é¢˜ï¼ˆ1å°æ—¶ï¼‰

### 4.1 å­—èŠ‚è·³åŠ¨ï¼šçº¿ç¨‹æ± å‚æ•°å¦‚ä½•è®¾ç½®ï¼Ÿ

**âŒ é”™è¯¯å›ç­”ï¼š**
> CPUå¯†é›†å‹ç”¨ N+1ï¼ŒIOå¯†é›†å‹ç”¨ 2Nã€‚

**âœ… æ­£ç¡®å›ç­”ï¼š**
> 1. å…ˆåˆ†æä¸šåŠ¡ç±»å‹ï¼ˆCPUå¯†é›† or IOå¯†é›†ï¼‰
> 2. å†å‹æµ‹ç¡®å®šå‚æ•°ï¼ˆä¸åŒå‚æ•°ä¸‹çš„QPSã€RTï¼‰
> 3. æœ€åç›‘æ§è°ƒä¼˜ï¼ˆæ ¹æ®å®é™…è¿è¡Œæƒ…å†µè°ƒæ•´ï¼‰
> 
> æˆ‘ä»¬é¡¹ç›®æ˜¯IOå¯†é›†å‹ï¼ˆæ•°æ®åº“æŸ¥è¯¢å 80%ï¼‰ï¼Œå‹æµ‹ç»“æœï¼š
> - CPUÃ—4: QPS=700, RT=180ms
> - CPUÃ—8: QPS=850, RT=150ms âœ…
> - CPUÃ—16: QPS=900, RT=160msï¼ˆæå‡ä¸æ˜æ˜¾ï¼‰
> 
> æœ€ç»ˆé€‰æ‹© CPUÃ—8ï¼Œæ€§ä»·æ¯”æœ€é«˜ã€‚

**å…³é”®ï¼šæœ‰æ•°æ®æ”¯æ’‘ï¼**

### 4.2 é˜¿é‡Œå·´å·´ï¼šThreadLocal å†…å­˜æ³„æ¼é—®é¢˜

**âŒ é”™è¯¯å›ç­”ï¼š**
> ThreadLocal ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Œå› ä¸º key æ˜¯å¼±å¼•ç”¨ã€‚

**âœ… æ­£ç¡®å›ç­”ï¼š**
> 1. **åŸç†**ï¼šThreadLocalMap çš„ Entry ç»§æ‰¿ WeakReferenceï¼Œkeyï¼ˆThreadLocalï¼‰æ˜¯å¼±å¼•ç”¨ï¼Œvalue æ˜¯å¼ºå¼•ç”¨ã€‚
> 2. **é—®é¢˜**ï¼šThreadLocal è¢«GCåï¼Œkey=nullï¼Œä½† value ä»å­˜åœ¨ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚
> 3. **è§£å†³**ï¼š
>    - ä½¿ç”¨å®Œåè°ƒç”¨ `remove()`
>    - çº¿ç¨‹æ± åœºæ™¯ä¸‹ï¼Œçº¿ç¨‹å¤ç”¨ä¼šåŠ å‰§é—®é¢˜
>    - é¡¹ç›®ä¸­ä½¿ç”¨ TransmittableThreadLocal + è‡ªåŠ¨æ¸…ç†
> 
> æˆ‘ä»¬é¡¹ç›®ä¸­é‡åˆ°è¿‡ä¸€æ¬¡å†…å­˜æ³„æ¼ï¼Œæ’æŸ¥è¿‡ç¨‹ï¼š
> - jmap dump å †å†…å­˜
> - MAT åˆ†æï¼Œå‘ç°å¤§é‡ ThreadLocalMap.Entry
> - å®šä½åˆ°æŸä¸ª ThreadLocal æ²¡æœ‰ remove
> - ä¿®å¤åï¼Œå†…å­˜å ç”¨ä» 2GB é™åˆ° 500MB

**å…³é”®ï¼šæœ‰å®æˆ˜ç»éªŒï¼**

### 4.3 æ‹¼å¤šå¤šï¼šCompletableFuture å¼‚å¸¸å¤„ç†

**é—®é¢˜ï¼š** 5ä¸ªä»»åŠ¡å¹¶è¡Œæ‰§è¡Œï¼Œå…¶ä¸­1ä¸ªå¤±è´¥ï¼Œå¦‚ä½•å¤„ç†ï¼Ÿ

**æ–¹æ¡ˆå¯¹æ¯”ï¼š**

```java
// æ–¹æ¡ˆ1ï¼šexceptionallyï¼ˆå•ä¸ªä»»åŠ¡å¼‚å¸¸å¤„ç†ï¼‰
CompletableFuture<String> f1 = CompletableFuture.supplyAsync(() -> {
    if (Math.random() > 0.5) throw new RuntimeException("error");
    return "success";
}).exceptionally(ex -> {
    log.error("Task failed", ex);
    return "default"; // è¿”å›é»˜è®¤å€¼
});

// æ–¹æ¡ˆ2ï¼šhandleï¼ˆç»Ÿä¸€å¤„ç†æˆåŠŸå’Œå¤±è´¥ï¼‰
CompletableFuture<String> f2 = CompletableFuture.supplyAsync(() -> {
    if (Math.random() > 0.5) throw new RuntimeException("error");
    return "success";
}).handle((result, ex) -> {
    if (ex != null) {
        log.error("Task failed", ex);
        return "default";
    }
    return result;
});

// æ–¹æ¡ˆ3ï¼šallOf + å•ç‹¬å¤„ç†ï¼ˆæ¨èï¼‰
CompletableFuture<String> f1 = CompletableFuture.supplyAsync(() -> task1()).exceptionally(ex -> "default1");
CompletableFuture<String> f2 = CompletableFuture.supplyAsync(() -> task2()).exceptionally(ex -> "default2");
CompletableFuture<String> f3 = CompletableFuture.supplyAsync(() -> task3()).exceptionally(ex -> "default3");

CompletableFuture.allOf(f1, f2, f3).join(); // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼ˆåŒ…æ‹¬å¤±è´¥çš„ï¼‰

String result1 = f1.get(); // æˆåŠŸè¿”å›ç»“æœï¼Œå¤±è´¥è¿”å›é»˜è®¤å€¼
String result2 = f2.get();
String result3 = f3.get();
```

**é¡¹ç›®å®è·µï¼š** 5ä¸ªæ•°æ®æºæŸ¥è¯¢ï¼Œå…è®¸éƒ¨åˆ†å¤±è´¥ã€‚

---

## äº”ã€è¸©å‘è®°å½•ï¼ˆè¡€æ³ªå²ï¼‰

### 5.1 å‘1ï¼šçº¿ç¨‹æ± é˜Ÿåˆ—æ»¡äº†å¯¼è‡´è¯·æ±‚å¤±è´¥

**ç°è±¡ï¼š** é«˜å³°æœŸå¤§é‡è¯·æ±‚å¤±è´¥ï¼Œæ—¥å¿—æ˜¾ç¤º `RejectedExecutionException`ã€‚

**åŸå› ï¼š** é˜Ÿåˆ—å®¹é‡è®¾ç½®å¤ªå°ï¼ˆ100ï¼‰ï¼Œé«˜å³°æœŸä»»åŠ¡å †ç§¯ã€‚

**æ’æŸ¥è¿‡ç¨‹ï¼š**
1. ç›‘æ§å‘ç°çº¿ç¨‹æ± é˜Ÿåˆ—æ»¡äº†
2. æŸ¥çœ‹é…ç½®ï¼š`queueCapacity=100`
3. æŸ¥çœ‹ä¸šåŠ¡ï¼šé«˜å³°æœŸQPS=500ï¼Œæ¯ä¸ªä»»åŠ¡è€—æ—¶200ms
4. è®¡ç®—ï¼š500 Ã— 0.2 = 100ä¸ªä»»åŠ¡/ç§’ï¼Œé˜Ÿåˆ—1ç§’å°±æ»¡äº†

**è§£å†³æ–¹æ¡ˆï¼š**
```java
// ä¼˜åŒ–å‰
new LinkedBlockingQueue<>(100)

// ä¼˜åŒ–å
new LinkedBlockingQueue<>(500) // é˜Ÿåˆ—å®¹é‡æ‰©å¤§5å€

// ç›‘æ§å‘Šè­¦
if (executor.getQueue().size() > queueCapacity * 0.8) {
    log.warn("çº¿ç¨‹æ± é˜Ÿåˆ—å³å°†æ»¡ï¼Œå½“å‰å¤§å°ï¼š{}", executor.getQueue().size());
}
```

**æ•™è®­ï¼š** é˜Ÿåˆ—å®¹é‡ = QPS Ã— å¹³å‡è€—æ—¶ Ã— å®‰å…¨ç³»æ•°ï¼ˆ2-5å€ï¼‰

### 5.2 å‘2ï¼šThreadLocal å¯¼è‡´å†…å­˜æ³„æ¼

**ç°è±¡ï¼š** æœåŠ¡è¿è¡Œä¸€æ®µæ—¶é—´åï¼Œå†…å­˜æŒç»­å¢é•¿ï¼Œæœ€ç»ˆOOMã€‚

**æ’æŸ¥è¿‡ç¨‹ï¼š**
1. jmap -dump:live,format=b,file=heap.bin <pid>
2. MAT åˆ†æï¼Œå‘ç°å¤§é‡ ThreadLocalMap.Entry
3. å®šä½åˆ° UserContext æ²¡æœ‰ remove
4. çº¿ç¨‹æ± å¤ç”¨çº¿ç¨‹ï¼ŒThreadLocal ä¸€ç›´ä¸é‡Šæ”¾

**è§£å†³æ–¹æ¡ˆï¼š**
```java
// ä¼˜åŒ–å‰
public class UserContext {
    private static final ThreadLocal<User> USER = new ThreadLocal<>();
    
    public static void set(User user) {
        USER.set(user);
    }
    
    public static User get() {
        return USER.get();
    }
    // âŒ æ²¡æœ‰ remove
}

// ä¼˜åŒ–å
public class UserContext {
    private static final TransmittableThreadLocal<User> USER = new TransmittableThreadLocal<>();
    
    public static void set(User user) {
        USER.set(user);
    }
    
    public static User get() {
        return USER.get();
    }
    
    public static void remove() {
        USER.remove(); // âœ… ä½¿ç”¨å®Œåæ¸…ç†
    }
}

// æ‹¦æˆªå™¨ä¸­è‡ªåŠ¨æ¸…ç†
@Override
public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) {
    UserContext.remove();
}
```

**æ•™è®­ï¼š** ThreadLocal ä½¿ç”¨å®Œåä¸€å®šè¦ removeï¼

---

## å…­ã€æ€»ç»“

### æ ¸å¿ƒåŸåˆ™

1. **æ•°æ®ç»“æ„ä¼˜å…ˆ**ï¼šçº¿ç¨‹æ± çš„æœ¬è´¨æ˜¯"ä»»åŠ¡é˜Ÿåˆ— + çº¿ç¨‹å¤ç”¨"
2. **æ¶ˆé™¤ç‰¹æ®Šæƒ…å†µ**ï¼šç»Ÿä¸€ä½¿ç”¨çº¿ç¨‹æ± ï¼Œä¸è¦ new Thread
3. **å®ç”¨ä¸»ä¹‰**ï¼šå‚æ•°é…ç½®è¦æµ‹è¯•ï¼Œä¸è¦æ‹è„‘è¢‹

### å¿«é€Ÿæ£€æŸ¥æ¸…å•

- âœ… çº¿ç¨‹æ± å‚æ•°æ˜¯å¦ç»è¿‡å‹æµ‹ï¼Ÿ
- âœ… æ˜¯å¦æœ‰ç›‘æ§å’Œå‘Šè­¦ï¼Ÿ
- âœ… ThreadLocal æ˜¯å¦æœ‰ removeï¼Ÿ
- âœ… å¼‚å¸¸æ˜¯å¦æœ‰å¤„ç†ï¼Ÿ
- âœ… æ˜¯å¦æœ‰é™çº§æ–¹æ¡ˆï¼Ÿ

---

**"Talk is cheap. Show me the code."**

