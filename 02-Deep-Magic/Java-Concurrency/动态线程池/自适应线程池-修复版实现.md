# è‡ªé€‚åº”çº¿ç¨‹æ±  - ä¿®å¤ç‰ˆå®ç°

> **"è¿™æ‰æ˜¯è¯¥æ­»çš„æ­£ç¡®å®ç°ã€‚"**

---

## ä¸€ã€ä¿®å¤ç‰ˆä»£ç 

### 1.1 é…ç½®ç±»

```java
package com.smart.adp.infrastructure.config;

import com.alibaba.ttl.threadpool.TtlExecutors;
import io.micrometer.core.instrument.MeterRegistry;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.scheduling.annotation.EnableScheduling;
import org.springframework.scheduling.annotation.Scheduled;

import java.util.concurrent.*;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.concurrent.atomic.AtomicLong;

/**
 * è‡ªé€‚åº”çº¿ç¨‹æ± é…ç½®ï¼ˆä¿®å¤ç‰ˆï¼‰
 * 
 * ä¿®å¤å†…å®¹ï¼š
 * 1. æ¸è¿›å¼æ‰©å®¹ï¼ˆ2å€è€Œä¸æ˜¯16å€ï¼‰
 * 2. ä¿å®ˆç¼©å®¹ï¼ˆè¿ç»­3æ¬¡ä½è´Ÿè½½æ‰ç¼©å®¹ï¼‰
 * 3. å®šæ—¶è°ƒæ•´ï¼ˆè€Œä¸æ˜¯æ¯ä¸ªä»»åŠ¡éƒ½è°ƒæ•´ï¼‰
 * 4. ç§»é™¤ allowCoreThreadTimeOutï¼ˆé¿å…å†²çªï¼‰
 * 5. æ·»åŠ ç›‘æ§æŒ‡æ ‡
 */
@Slf4j
@Configuration
@EnableScheduling
public class AdaptiveThreadPoolConfig {

    private static final int CPU_COUNT = Runtime.getRuntime().availableProcessors();

    @Value("${thread-pool.coreSizeMultiple:8}")
    private int coreSizeMultiple;

    @Value("${thread-pool.maxSizeMultiple:16}")
    private int maxSizeMultiple;

    @Value("${thread-pool.queueCapacity:1000}")
    private int queueCapacity;

    private ThreadPoolExecutor smartExecutor;
    
    // ç›‘æ§æŒ‡æ ‡
    private final AtomicLong scaleUpCount = new AtomicLong(0);
    private final AtomicLong scaleDownCount = new AtomicLong(0);
    private int lowLoadCount = 0;

    @Bean(name = "smartExecutor")
    public Executor smartExecutor(MeterRegistry meterRegistry) {
        smartExecutor = new ThreadPoolExecutor(
            CPU_COUNT * coreSizeMultiple,
            CPU_COUNT * maxSizeMultiple,
            60L, TimeUnit.SECONDS,
            new LinkedBlockingQueue<>(queueCapacity),
            new ThreadFactory() {
                private final AtomicInteger counter = new AtomicInteger(1);

                @Override
                public Thread newThread(Runnable r) {
                    Thread thread = new Thread(r, "smart-pool-" + counter.getAndIncrement());
                    thread.setDaemon(false);
                    thread.setUncaughtExceptionHandler((t, e) -> 
                        log.error("Thread [{}] error: ", t.getName(), e)
                    );
                    return thread;
                }
            },
            new ThreadPoolExecutor.CallerRunsPolicy()
        );

        // âœ… ä¸ä½¿ç”¨ allowCoreThreadTimeOutï¼ˆé¿å…ä¸è‡ªé€‚åº”å†²çªï¼‰
        smartExecutor.allowCoreThreadTimeOut(false);

        // æ³¨å†Œç›‘æ§æŒ‡æ ‡
        registerMetrics(meterRegistry);

        log.info("è‡ªé€‚åº”çº¿ç¨‹æ± åˆå§‹åŒ–å®Œæˆ - æ ¸å¿ƒçº¿ç¨‹æ•°: {}, æœ€å¤§çº¿ç¨‹æ•°: {}, é˜Ÿåˆ—å®¹é‡: {}",
                CPU_COUNT * coreSizeMultiple, CPU_COUNT * maxSizeMultiple, queueCapacity);

        return TtlExecutors.getTtlExecutor(smartExecutor);
    }

    /**
     * å®šæ—¶è°ƒæ•´çº¿ç¨‹æ± ï¼ˆæ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼‰
     */
    @Scheduled(fixedRate = 60000)
    public void adjustThreadPool() {
        if (smartExecutor == null) {
            return;
        }

        int activeCount = smartExecutor.getActiveCount();
        int queueSize = smartExecutor.getQueue().size();
        int coreSize = smartExecutor.getCorePoolSize();
        int poolSize = smartExecutor.getPoolSize();

        // è®¡ç®—è´Ÿè½½ç‡
        double loadRate = (double) activeCount / coreSize;
        double queueRate = (double) queueSize / queueCapacity;

        log.info("çº¿ç¨‹æ± çŠ¶æ€ - æ ¸å¿ƒçº¿ç¨‹: {}, æ´»è·ƒçº¿ç¨‹: {}, æ± å¤§å°: {}, é˜Ÿåˆ—: {}/{}, è´Ÿè½½ç‡: {:.2f}, é˜Ÿåˆ—ç‡: {:.2f}",
                coreSize, activeCount, poolSize, queueSize, queueCapacity, loadRate, queueRate);

        // æ‰©å®¹é€»è¾‘
        if (shouldScaleUp(loadRate, queueRate, coreSize)) {
            scaleUp(coreSize);
        }
        // ç¼©å®¹é€»è¾‘
        else if (shouldScaleDown(loadRate, queueRate, coreSize)) {
            scaleDown(coreSize);
        } else {
            lowLoadCount = 0;
        }
    }

    /**
     * æ˜¯å¦åº”è¯¥æ‰©å®¹
     */
    private boolean shouldScaleUp(double loadRate, double queueRate, int coreSize) {
        // æ¡ä»¶1ï¼šè´Ÿè½½ç‡ >= 80%
        // æ¡ä»¶2ï¼šé˜Ÿåˆ—ä½¿ç”¨ç‡ >= 50%
        // æ¡ä»¶3ï¼šæœªè¾¾åˆ°æœ€å¤§çº¿ç¨‹æ•°
        return loadRate >= 0.8 
            && queueRate >= 0.5 
            && coreSize < CPU_COUNT * maxSizeMultiple;
    }

    /**
     * æ‰©å®¹ï¼ˆæ¸è¿›å¼ï¼šæ¯æ¬¡2å€ï¼‰
     */
    private void scaleUp(int coreSize) {
        int newCore = Math.min(coreSize * 2, CPU_COUNT * maxSizeMultiple);
        
        if (newCore > coreSize) {
            smartExecutor.setCorePoolSize(newCore);
            scaleUpCount.incrementAndGet();
            
            log.warn("ğŸ”º çº¿ç¨‹æ± æ‰©å®¹ - {} â†’ {} (æ‰©å®¹æ¬¡æ•°: {})", 
                    coreSize, newCore, scaleUpCount.get());
        }
    }

    /**
     * æ˜¯å¦åº”è¯¥ç¼©å®¹
     */
    private boolean shouldScaleDown(double loadRate, double queueRate, int coreSize) {
        // æ¡ä»¶1ï¼šè´Ÿè½½ç‡ < 30%
        // æ¡ä»¶2ï¼šé˜Ÿåˆ—ä½¿ç”¨ç‡ < 25%
        // æ¡ä»¶3ï¼šæœªè¾¾åˆ°æœ€å°çº¿ç¨‹æ•°
        if (loadRate < 0.3 
            && queueRate < 0.25 
            && coreSize > CPU_COUNT * coreSizeMultiple) {
            
            lowLoadCount++;
            
            // æ¡ä»¶4ï¼šè¿ç»­3æ¬¡ä½è´Ÿè½½ï¼ˆé¿å…é¢‘ç¹ç¼©å®¹ï¼‰
            return lowLoadCount >= 3;
        }
        
        return false;
    }

    /**
     * ç¼©å®¹ï¼ˆä¿å®ˆï¼šæ¯æ¬¡å‡åŠï¼‰
     */
    private void scaleDown(int coreSize) {
        int newCore = Math.max(coreSize / 2, CPU_COUNT * coreSizeMultiple);
        
        if (newCore < coreSize) {
            smartExecutor.setCorePoolSize(newCore);
            scaleDownCount.incrementAndGet();
            
            log.warn("ğŸ”» çº¿ç¨‹æ± ç¼©å®¹ - {} â†’ {} (ç¼©å®¹æ¬¡æ•°: {})", 
                    coreSize, newCore, scaleDownCount.get());
        }
        
        lowLoadCount = 0;
    }

    /**
     * æ³¨å†Œç›‘æ§æŒ‡æ ‡ï¼ˆPrometheusï¼‰
     */
    private void registerMetrics(MeterRegistry meterRegistry) {
        // æ ¸å¿ƒçº¿ç¨‹æ•°
        meterRegistry.gauge("thread_pool.core_size", smartExecutor, ThreadPoolExecutor::getCorePoolSize);
        
        // æœ€å¤§çº¿ç¨‹æ•°
        meterRegistry.gauge("thread_pool.max_size", smartExecutor, ThreadPoolExecutor::getMaximumPoolSize);
        
        // å½“å‰çº¿ç¨‹æ•°
        meterRegistry.gauge("thread_pool.pool_size", smartExecutor, ThreadPoolExecutor::getPoolSize);
        
        // æ´»è·ƒçº¿ç¨‹æ•°
        meterRegistry.gauge("thread_pool.active_count", smartExecutor, ThreadPoolExecutor::getActiveCount);
        
        // é˜Ÿåˆ—å¤§å°
        meterRegistry.gauge("thread_pool.queue_size", smartExecutor, e -> e.getQueue().size());
        
        // å·²å®Œæˆä»»åŠ¡æ•°
        meterRegistry.gauge("thread_pool.completed_task_count", smartExecutor, ThreadPoolExecutor::getCompletedTaskCount);
        
        // æ‰©å®¹æ¬¡æ•°
        meterRegistry.gauge("thread_pool.scale_up_count", scaleUpCount, AtomicLong::get);
        
        // ç¼©å®¹æ¬¡æ•°
        meterRegistry.gauge("thread_pool.scale_down_count", scaleDownCount, AtomicLong::get);
    }
}
```

---

## äºŒã€é…ç½®æ–‡ä»¶

```yaml
# application.yml
thread-pool:
  coreSizeMultiple: 8      # æ ¸å¿ƒçº¿ç¨‹å€æ•°ï¼ˆæœ€å°å€¼ï¼‰
  maxSizeMultiple: 16      # æœ€å¤§çº¿ç¨‹å€æ•°ï¼ˆæœ€å¤§å€¼ï¼‰
  queueCapacity: 1000      # é˜Ÿåˆ—å®¹é‡
```

---

## ä¸‰ã€ç›‘æ§å‘Šè­¦

### 3.1 Prometheus æŒ‡æ ‡

```text
# æ ¸å¿ƒçº¿ç¨‹æ•°
thread_pool_core_size{job="adp-agent-clue"} 64

# æ´»è·ƒçº¿ç¨‹æ•°
thread_pool_active_count{job="adp-agent-clue"} 32

# é˜Ÿåˆ—å¤§å°
thread_pool_queue_size{job="adp-agent-clue"} 100

# æ‰©å®¹æ¬¡æ•°
thread_pool_scale_up_count{job="adp-agent-clue"} 5

# ç¼©å®¹æ¬¡æ•°
thread_pool_scale_down_count{job="adp-agent-clue"} 3
```

### 3.2 Grafana é¢æ¿

```json
{
  "panels": [
    {
      "title": "çº¿ç¨‹æ± æ ¸å¿ƒçº¿ç¨‹æ•°",
      "targets": [
        {
          "expr": "thread_pool_core_size"
        }
      ]
    },
    {
      "title": "çº¿ç¨‹æ± è´Ÿè½½ç‡",
      "targets": [
        {
          "expr": "thread_pool_active_count / thread_pool_core_size"
        }
      ]
    },
    {
      "title": "é˜Ÿåˆ—ä½¿ç”¨ç‡",
      "targets": [
        {
          "expr": "thread_pool_queue_size / 1000"
        }
      ]
    },
    {
      "title": "æ‰©ç¼©å®¹æ¬¡æ•°",
      "targets": [
        {
          "expr": "thread_pool_scale_up_count",
          "legendFormat": "æ‰©å®¹"
        },
        {
          "expr": "thread_pool_scale_down_count",
          "legendFormat": "ç¼©å®¹"
        }
      ]
    }
  ]
}
```

### 3.3 å‘Šè­¦è§„åˆ™

```yaml
# prometheus-alerts.yml
groups:
  - name: thread_pool_alerts
    interval: 30s
    rules:
      # é˜Ÿåˆ—ç§¯å‹å‘Šè­¦
      - alert: ThreadPoolQueueHigh
        expr: thread_pool_queue_size > 800
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "çº¿ç¨‹æ± é˜Ÿåˆ—ç§¯å‹ä¸¥é‡"
          description: "é˜Ÿåˆ—å¤§å°: {{ $value }}, è¶…è¿‡é˜ˆå€¼ 800"

      # è´Ÿè½½è¿‡é«˜å‘Šè­¦
      - alert: ThreadPoolLoadHigh
        expr: thread_pool_active_count / thread_pool_core_size > 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "çº¿ç¨‹æ± è´Ÿè½½è¿‡é«˜"
          description: "è´Ÿè½½ç‡: {{ $value }}, è¶…è¿‡ 90%"

      # é¢‘ç¹æ‰©å®¹å‘Šè­¦
      - alert: ThreadPoolScaleUpFrequent
        expr: increase(thread_pool_scale_up_count[1h]) > 10
        labels:
          severity: info
        annotations:
          summary: "çº¿ç¨‹æ± é¢‘ç¹æ‰©å®¹"
          description: "1å°æ—¶å†…æ‰©å®¹ {{ $value }} æ¬¡"
```

---

## å››ã€ä½¿ç”¨ç¤ºä¾‹

```java
@Service
public class ClueService {

    @Autowired
    @Qualifier("smartExecutor")
    private Executor smartExecutor;

    /**
     * å¼‚æ­¥å¤„ç†çº¿ç´¢
     */
    @Async("smartExecutor")
    public void processClue(String clueId) {
        // ä¸šåŠ¡é€»è¾‘
        log.info("å¤„ç†çº¿ç´¢: {}", clueId);
    }

    /**
     * æ‰¹é‡å¤„ç†çº¿ç´¢
     */
    public void batchProcessClues(List<String> clueIds) {
        List<CompletableFuture<Void>> futures = clueIds.stream()
            .map(clueId -> CompletableFuture.runAsync(
                () -> processClue(clueId), 
                smartExecutor
            ))
            .collect(Collectors.toList());

        CompletableFuture.allOf(futures.toArray(new CompletableFuture[0])).join();
    }
}
```

---

## äº”ã€æµ‹è¯•éªŒè¯

### 5.1 å‹æµ‹è„šæœ¬

```bash
#!/bin/bash

# å‹æµ‹å·¥å…·ï¼šwrk
# å®‰è£…ï¼šbrew install wrk (Mac) æˆ– apt-get install wrk (Linux)

# ä½è´Ÿè½½æµ‹è¯•ï¼ˆQPS=100ï¼‰
wrk -t4 -c100 -d60s --latency http://localhost:8080/api/clue/process

# é«˜è´Ÿè½½æµ‹è¯•ï¼ˆQPS=1000ï¼‰
wrk -t8 -c1000 -d60s --latency http://localhost:8080/api/clue/process

# æ³¢åŠ¨è´Ÿè½½æµ‹è¯•
for i in {1..10}; do
  echo "Round $i - é«˜è´Ÿè½½"
  wrk -t8 -c1000 -d30s http://localhost:8080/api/clue/process
  
  echo "Round $i - ä½è´Ÿè½½"
  wrk -t2 -c50 -d30s http://localhost:8080/api/clue/process
  
  sleep 10
done
```

### 5.2 é¢„æœŸç»“æœ

```text
æµ‹è¯•åœºæ™¯ï¼šæ³¢åŠ¨è´Ÿè½½ï¼ˆé«˜å³°1000 QPSï¼Œä½å³°100 QPSï¼‰

æ—¶é—´çº¿ï¼š
00:00 - åˆå§‹çŠ¶æ€
  - æ ¸å¿ƒçº¿ç¨‹æ•°: 64
  - æ´»è·ƒçº¿ç¨‹: 10
  - é˜Ÿåˆ—: 0

00:30 - é«˜å³°æœŸå¼€å§‹
  - æ ¸å¿ƒçº¿ç¨‹æ•°: 64
  - æ´»è·ƒçº¿ç¨‹: 60
  - é˜Ÿåˆ—: 500
  - è´Ÿè½½ç‡: 93%
  - é˜Ÿåˆ—ç‡: 50%

01:00 - è§¦å‘æ‰©å®¹ï¼ˆè´Ÿè½½ç‡ >= 80% && é˜Ÿåˆ—ç‡ >= 50%ï¼‰
  - æ ¸å¿ƒçº¿ç¨‹æ•°: 64 â†’ 128
  - æ´»è·ƒçº¿ç¨‹: 120
  - é˜Ÿåˆ—: 100
  - è´Ÿè½½ç‡: 93%
  - é˜Ÿåˆ—ç‡: 10%

01:30 - é«˜å³°æœŸç»“æŸ
  - æ ¸å¿ƒçº¿ç¨‹æ•°: 128
  - æ´»è·ƒçº¿ç¨‹: 30
  - é˜Ÿåˆ—: 50
  - è´Ÿè½½ç‡: 23%
  - é˜Ÿåˆ—ç‡: 5%
  - lowLoadCount: 1

02:00 - ä½è´Ÿè½½æŒç»­
  - lowLoadCount: 2

02:30 - ä½è´Ÿè½½æŒç»­
  - lowLoadCount: 3

03:00 - è§¦å‘ç¼©å®¹ï¼ˆè¿ç»­3æ¬¡ä½è´Ÿè½½ï¼‰
  - æ ¸å¿ƒçº¿ç¨‹æ•°: 128 â†’ 64
  - æ´»è·ƒçº¿ç¨‹: 10
  - é˜Ÿåˆ—: 0
```

---

## å…­ã€å¯¹æ¯”æ€»ç»“

| ç»´åº¦ | åŸç‰ˆå®ç° | ä¿®å¤ç‰ˆå®ç° |
|------|---------|-----------|
| **æ‰©å®¹å€æ•°** | âŒ 16å€ï¼ˆè¿‡æ¿€ï¼‰ | âœ… 2å€ï¼ˆæ¸è¿›ï¼‰ |
| **æ‰©å®¹æ—¶æœº** | âŒ æ¯ä¸ªä»»åŠ¡åˆ¤æ–­ | âœ… æ¯åˆ†é’Ÿåˆ¤æ–­ |
| **ç¼©å®¹ç­–ç•¥** | âŒ ç«‹å³ç¼©å®¹ | âœ… è¿ç»­3æ¬¡ä½è´Ÿè½½ |
| **æœºåˆ¶å†²çª** | âŒ allowCoreThreadTimeOut | âœ… å•ä¸€æœºåˆ¶ |
| **ç›‘æ§æŒ‡æ ‡** | âŒ åªæœ‰æ—¥å¿— | âœ… PrometheusæŒ‡æ ‡ |
| **å‘Šè­¦** | âŒ æ—  | âœ… é˜Ÿåˆ—/è´Ÿè½½/æ‰©å®¹å‘Šè­¦ |
| **å¯æµ‹è¯•æ€§** | âŒ éš¾ä»¥éªŒè¯ | âœ… å®Œæ•´å‹æµ‹è„šæœ¬ |
| **ç”Ÿäº§å¯ç”¨** | âŒ ä¸æ¨è | âœ… å¯ç”¨ |

---

## ä¸ƒã€Linus å¼æœ€ç»ˆè¯„ä»·

```text
"ç°åœ¨è¿™æ‰åƒè¯ã€‚"

âœ… å¥½çš„åœ°æ–¹ï¼š
1. æ¸è¿›å¼æ‰©å®¹ï¼ˆ2å€ï¼‰ï¼Œä¸ä¼šç¬é—´åˆ›å»ºå¤§é‡çº¿ç¨‹
2. ä¿å®ˆç¼©å®¹ï¼ˆè¿ç»­3æ¬¡ä½è´Ÿè½½ï¼‰ï¼Œé¿å…é¢‘ç¹æŠ–åŠ¨
3. å®šæ—¶è°ƒæ•´ï¼ˆæ¯åˆ†é’Ÿï¼‰ï¼Œè€Œä¸æ˜¯æ¯ä¸ªä»»åŠ¡éƒ½åˆ¤æ–­
4. å•ä¸€æœºåˆ¶ï¼Œæ²¡æœ‰å†²çª
5. å®Œå–„çš„ç›‘æ§å’Œå‘Šè­¦
6. å¯æµ‹è¯•ã€å¯éªŒè¯

âš ï¸ è¿˜å¯ä»¥æ”¹è¿›çš„ï¼š
1. æ‰©ç¼©å®¹é˜ˆå€¼å¯ä»¥é…ç½®åŒ–ï¼ˆç›®å‰ç¡¬ç¼–ç ï¼‰
2. å¯ä»¥åŠ å…¥æœºå™¨å­¦ä¹ é¢„æµ‹ï¼ˆæ ¹æ®å†å²æ•°æ®é¢„æµ‹è´Ÿè½½ï¼‰
3. å¯ä»¥åŠ å…¥ç†”æ–­æœºåˆ¶ï¼ˆè´Ÿè½½è¿‡é«˜æ—¶æ‹’ç»æ–°ä»»åŠ¡ï¼‰

ä½†æ€»ä½“æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ª"å¯ç”¨"çš„å®ç°ã€‚

è¯„åˆ†ï¼š85/100

"Good job. Now go test it in production."
```

---

**"Talk is cheap. Show me the code."**

