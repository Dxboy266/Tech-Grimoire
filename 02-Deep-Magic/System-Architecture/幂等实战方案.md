# å¹‚ç­‰å®æˆ˜æ–¹æ¡ˆ

> ğŸ’¡ ç†è®ºåŸºç¡€å‚è€ƒï¼š[å¹‚ç­‰ç†è®ºæ¡†æ¶](./å¹‚ç­‰ç†è®ºæ¡†æ¶.md)

## ä¸‰ç§å®ç°æ–¹æ¡ˆ

| æ–¹æ¡ˆ | é€‚ç”¨åœºæ™¯ | ç‰¹ç‚¹ |
|------|---------|------|
| Redis | æ™®é€šä¸šåŠ¡ | æ€§èƒ½é«˜ï¼ŒRedis æŒ‚äº†ä¼šçŸ­æš‚å¤±æ•ˆ |
| æ•°æ®åº“ | èµ„é‡‘ç±» | æ•°æ®æŒä¹…åŒ–ï¼Œæ€§èƒ½ä¸€èˆ¬ |
| Redis + DB | æ”¯ä»˜/è½¬è´¦ | Redis æŒ¡å¹¶å‘ï¼ŒDB ä¿å¯é  |

## æ–¹æ¡ˆä¸€ï¼šRedis å®ç°

```java
String key = "idempotent:" + bizType + ":" + idemKey;
Boolean success = redis.setNx(key, "1", 7, TimeUnit.DAYS);

if (!success) {
    throw new BizException("é‡å¤è¯·æ±‚");
}
// æ‰§è¡Œä¸šåŠ¡é€»è¾‘
```

åˆ©ç”¨ SETNX åŸå­æ€§ï¼Œå¹¶å‘ä¸‹åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ’å…¥æˆåŠŸã€‚

## æ–¹æ¡ˆäºŒï¼šæ•°æ®åº“å®ç°

### è¡¨ç»“æ„

```sql
CREATE TABLE idempotent_record (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    idem_key VARCHAR(64) NOT NULL COMMENT 'å¹‚ç­‰å”¯ä¸€æ ‡è¯†',
    biz_type VARCHAR(32) NOT NULL COMMENT 'ä¸šåŠ¡ç±»å‹',
    payload_hash VARCHAR(64) NOT NULL COMMENT 'è¯·æ±‚å‚æ•°æ‘˜è¦',
    status TINYINT NOT NULL COMMENT '0-å¤„ç†ä¸­ 1-æˆåŠŸ 2-å¤±è´¥',
    result_payload TEXT COMMENT 'å¤„ç†ç»“æœï¼ˆå¹‚ç­‰è¿”å›ï¼‰',
    expire_at DATETIME NOT NULL COMMENT 'è¿‡æœŸæ—¶é—´',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_idem_biz (idem_key, biz_type),
    KEY idx_status_updated (status, updated_at),
    KEY idx_expire (expire_at)
) COMMENT='å¹‚ç­‰è®°å½•è¡¨';
```

**ç´¢å¼•è¯´æ˜ï¼š**
- `uk_idem_biz`ï¼šä¿è¯å¹‚ç­‰
- `idx_status_updated`ï¼šè¡¥å¿ JOB æŸ¥åƒµå°¸è®°å½•
- `idx_expire`ï¼šæ¸…ç†è¿‡æœŸæ•°æ®

### æ ¸å¿ƒå®ç°

```java
public Object executeWithIdempotent(String idemKey, String bizType, Object request) {
    try {
        // å…ˆæ’å…¥ï¼Œä¸è¦å…ˆæŸ¥ï¼ˆåˆ©ç”¨å”¯ä¸€ç´¢å¼•åŸå­æ€§ï¼‰
        IdempotentRecord record = new IdempotentRecord();
        record.setIdemKey(idemKey);
        record.setBizType(bizType);
        record.setPayloadHash(calcHash(request));
        record.setStatus(0); // å¤„ç†ä¸­
        record.setExpireAt(LocalDateTime.now().plusDays(7));
        
        mapper.insert(record);
        
        // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
        try {
            Object result = executeBiz(request);
            
            // æ›´æ–°ä¸ºæˆåŠŸ
            mapper.updateStatus(idemKey, bizType, 1, JSON.toJSONString(result));
            
            return result;
        } catch (Exception bizEx) {
            // ä¸šåŠ¡æ‰§è¡Œå¤±è´¥ï¼Œæ›´æ–°å¹‚ç­‰è¡¨
            mapper.updateStatus(idemKey, bizType, 2, bizEx.getMessage());
            throw bizEx;
        }
        
    } catch (DuplicateKeyException e) {
        // å”¯ä¸€é”®å†²çªï¼ŒæŸ¥å·²æœ‰è®°å½•
        IdempotentRecord exist = mapper.selectByKey(idemKey, bizType);
        
        // æ ¡éªŒå‚æ•°ï¼ˆé˜²æ­¢åŒ ID ä¸åŒå‚æ•°ï¼‰
        if (!calcHash(request).equals(exist.getPayloadHash())) {
            throw new BizException("è¯·æ±‚å‚æ•°å·²å˜æ›´ï¼Œè¯·ä½¿ç”¨æ–°çš„å¹‚ç­‰ ID");
        }
        
        // æ ¹æ®çŠ¶æ€è¿”å›
        if (exist.getStatus() == 1) {
            // æˆåŠŸï¼Œè¿”å›å¹‚ç­‰ç»“æœ
            return JSON.parseObject(exist.getResultPayload());
        } else if (exist.getStatus() == 0) {
            // å¤„ç†ä¸­ï¼Œæ‹’ç»é‡å…¥
            throw new BizException("è¯·æ±‚å¤„ç†ä¸­ï¼Œè¯·ç¨åé‡è¯•");
        } else {
            // å¤±è´¥ï¼Œæ ¹æ®ä¸šåŠ¡é…ç½®å†³å®šæ˜¯å¦å…è®¸é‡è¯•
            if (isRetryable(bizType)) {
                // å…è®¸é‡è¯•ï¼šåˆ é™¤å¤±è´¥è®°å½•ï¼Œé‡æ–°æ‰§è¡Œ
                mapper.deleteByKey(idemKey, bizType);
                return executeWithIdempotent(idemKey, bizType, request);
            } else {
                // ä¸å…è®¸é‡è¯•ï¼šç›´æ¥æ‹’ç»
                throw new BizException("è¯·æ±‚å·²å¤±è´¥ä¸”ä¸å¯é‡è¯•");
            }
        }
    }
}

// è®¡ç®—è¯·æ±‚å‚æ•°å“ˆå¸Œ
private String calcHash(Object request) {
    String json = JSON.toJSONString(request);
    return DigestUtils.md5Hex(json);
}

// åˆ¤æ–­ä¸šåŠ¡æ˜¯å¦å¯é‡è¯•ï¼ˆæ ¹æ®ä¸šåŠ¡ç±»å‹é…ç½®ï¼‰
private boolean isRetryable(String bizType) {
    // æ”¯ä»˜ã€æ‰£æ¬¾ç­‰ä¸å¯é‡è¯•
    if ("PAY".equals(bizType) || "DEDUCT".equals(bizType)) {
        return false;
    }
    // å…¶ä»–ä¸šåŠ¡å¯é‡è¯•
    return true;
}
```

**Mapper æ¥å£ï¼š**

```java
public interface IdempotentMapper {
    
    void insert(IdempotentRecord record);
    
    IdempotentRecord selectByKey(@Param("idemKey") String idemKey, 
                                   @Param("bizType") String bizType);
    
    void updateStatus(@Param("idemKey") String idemKey, 
                      @Param("bizType") String bizType,
                      @Param("status") int status, 
                      @Param("result") String result);
    
    void deleteByKey(@Param("idemKey") String idemKey, 
                     @Param("bizType") String bizType);
    
    List<IdempotentRecord> selectZombies(@Param("time") LocalDateTime time);
    
    int deleteExpired(@Param("now") LocalDateTime now);
}
```

**Mapper XMLï¼š**

```xml
<!-- æŸ¥è¯¢å¹‚ç­‰è®°å½• -->
<select id="selectByKey" resultType="IdempotentRecord">
    SELECT * FROM idempotent_record 
    WHERE idem_key = #{idemKey} AND biz_type = #{bizType}
</select>

<!-- æ›´æ–°çŠ¶æ€ -->
<update id="updateStatus">
    UPDATE idempotent_record 
    SET status = #{status}, 
        result_payload = #{result},
        updated_at = NOW()
    WHERE idem_key = #{idemKey} AND biz_type = #{bizType}
</update>

<!-- åˆ é™¤è®°å½• -->
<delete id="deleteByKey">
    DELETE FROM idempotent_record 
    WHERE idem_key = #{idemKey} AND biz_type = #{bizType}
</delete>

<!-- æŸ¥è¯¢åƒµå°¸è®°å½• -->
<select id="selectZombies" resultType="IdempotentRecord">
    SELECT * FROM idempotent_record 
    WHERE status = 0 
      AND updated_at &lt; #{time}
    LIMIT 100
</select>

<!-- åˆ é™¤è¿‡æœŸæ•°æ® -->
<delete id="deleteExpired">
    DELETE FROM idempotent_record 
    WHERE expire_at &lt; #{now}
    LIMIT 1000
</delete>
```

## æ–¹æ¡ˆä¸‰ï¼šRedis + æ•°æ®åº“åŒå†™

```java
public Object executeWithRedisAndDb(String idemKey, String bizType, Object request) {
    // 1. Redis å¿«é€Ÿæ‹¦æˆªï¼ˆæŒ¡ 99% é‡å¤è¯·æ±‚ï¼‰
    String redisKey = "idempotent:" + bizType + ":" + idemKey;
    Boolean redisSuccess = redis.setNx(redisKey, "1", 30, TimeUnit.SECONDS);
    
    if (!redisSuccess) {
        throw new BizException("é‡å¤è¯·æ±‚");
    }
    
    // 2. æ•°æ®åº“æŒä¹…åŒ–
    try {
        IdempotentRecord record = new IdempotentRecord();
        record.setIdemKey(idemKey);
        record.setBizType(bizType);
        record.setPayloadHash(calcHash(request));
        record.setStatus(0);
        record.setExpireAt(LocalDateTime.now().plusDays(7));
        
        mapper.insert(record);
        
        // 3. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
        try {
            Object result = executeBiz(request);
            mapper.updateStatus(idemKey, bizType, 1, JSON.toJSONString(result));
            return result;
        } catch (Exception bizEx) {
            mapper.updateStatus(idemKey, bizType, 2, bizEx.getMessage());
            throw bizEx;
        }
        
    } catch (DuplicateKeyException e) {
        // æ•°æ®åº“å·²æœ‰è®°å½•ï¼Œå¤„ç†é€»è¾‘åŒæ–¹æ¡ˆäºŒ
        IdempotentRecord exist = mapper.selectByKey(idemKey, bizType);
        
        if (!calcHash(request).equals(exist.getPayloadHash())) {
            throw new BizException("è¯·æ±‚å‚æ•°å·²å˜æ›´");
        }
        
        if (exist.getStatus() == 1) {
            return JSON.parseObject(exist.getResultPayload());
        } else if (exist.getStatus() == 0) {
            throw new BizException("è¯·æ±‚å¤„ç†ä¸­");
        } else {
            throw new BizException("è¯·æ±‚å·²å¤±è´¥");
        }
    }
}
```

Redis TTL è®¾ç½®çŸ­ä¸€ç‚¹ï¼ˆ10-30sï¼‰ï¼ŒåªæŒ¡ç¬æ—¶é‡å¤ï¼Œæ•°æ®åº“ä¿è¯æœ€ç»ˆä¸€è‡´ã€‚

## å…³é”®ç»†èŠ‚

### ä¸ºä»€ä¹ˆå…ˆæ’å…¥ä¸å…ˆæŸ¥ï¼Ÿ

å¹¶å‘ä¸‹ä¸¤ä¸ªçº¿ç¨‹éƒ½æŸ¥åˆ°ä¸å­˜åœ¨ï¼Œéƒ½ä¼šæ’å…¥æˆåŠŸï¼Œå¹‚ç­‰å¤±æ•ˆã€‚

å¿…é¡»ä¾èµ–å”¯ä¸€ç´¢å¼•åŸå­æ€§ï¼š
- ç¬¬ä¸€ä¸ªæ’å…¥æˆåŠŸ
- ç¬¬äºŒä¸ªè§¦å‘ `DuplicateKeyException`
- æ•è·å¼‚å¸¸åæŸ¥å·²æœ‰è®°å½•

### payload_hash çš„ä½œç”¨

é˜²æ­¢åŒ idem_key ä½†å‚æ•°ä¸åŒï¼š

```
ç¬¬ä¸€æ¬¡ï¼šè®¢å•é‡‘é¢ 100 å…ƒï¼Œidem_key = "order-001"
ç¬¬äºŒæ¬¡ï¼šè®¢å•é‡‘é¢ 200 å…ƒï¼Œidem_key = "order-001"ï¼ˆæ¶æ„ç¯¡æ”¹ï¼‰
```

é€šè¿‡ payload_hash æ ¡éªŒï¼Œæ‹’ç»å‚æ•°å˜æ›´ã€‚

### è¿‡æœŸæ—¶é—´è®¾ç½®

| ä¸šåŠ¡ç±»å‹ | è¿‡æœŸæ—¶é—´ |
|---------|---------|
| æ”¯ä»˜ | 3 å¤© |
| è®¢å• | 7 å¤© |
| è¥é”€å‘åˆ¸ | 7 å¤© |
| MQ æ¶ˆè´¹ | 30 å¤© |

åŸåˆ™ï¼šå¤§äºä¸šåŠ¡æœ€å¤§é‡è¯•çª—å£ã€‚

### äº‹åŠ¡è¾¹ç•Œ

#### åŒä¸€äº‹åŠ¡ï¼ˆæ¨èèµ„é‡‘ç±»ï¼‰

```java
@Transactional
public void execute() {
    // æ’å…¥å¹‚ç­‰è¡¨ PROCESSING
    // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    // æ›´æ–°å¹‚ç­‰è¡¨ SUCCESS
    // ä¸€èµ·æäº¤æˆ–å›æ»š
}
```

ä¸šåŠ¡å¤±è´¥å¹‚ç­‰è¡¨è‡ªåŠ¨å›æ»šï¼Œå¼ºä¸€è‡´ã€‚

#### åˆ†ç¦»äº‹åŠ¡

```java
// æ’å…¥å¹‚ç­‰è¡¨ï¼ˆç‹¬ç«‹äº‹åŠ¡ï¼‰
// æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼ˆç‹¬ç«‹äº‹åŠ¡ï¼‰
// æ›´æ–°å¹‚ç­‰è¡¨ï¼ˆç‹¬ç«‹äº‹åŠ¡ï¼‰
```

äº‹åŠ¡ç²’åº¦å°ï¼Œä½†ä¸šåŠ¡æˆåŠŸæ›´æ–°å¹‚ç­‰è¡¨å¤±è´¥æ—¶éœ€è¦è¡¥å¿ JOBã€‚

## ç”Ÿäº§å®è·µ

### åˆ†å¸ƒå¼åœºæ™¯å¹‚ç­‰é”®ä¼ é€’

**è®¢å•æœåŠ¡ï¼ˆä¸Šæ¸¸ï¼‰ï¼š**

```java
@RestController
public class OrderController {
    
    @PostMapping("/order/create")
    public Result createOrder(@RequestHeader("X-Idempotent-Key") String idemKey,
                              @RequestBody OrderRequest request) {
        // 1. åˆ›å»ºè®¢å•ï¼ˆä½¿ç”¨å¹‚ç­‰é”®ï¼‰
        Order order = executeWithIdempotent(idemKey, "CREATE_ORDER", request);
        
        // 2. è°ƒç”¨åº“å­˜æœåŠ¡ï¼ˆä¼ é€’åŒä¸€ä¸ªå¹‚ç­‰é”®ï¼‰
        stockService.deduct(idemKey, request.getItems());
        
        // 3. è°ƒç”¨æ”¯ä»˜æœåŠ¡ï¼ˆä¼ é€’åŒä¸€ä¸ªå¹‚ç­‰é”®ï¼‰
        payService.pay(idemKey, order.getAmount());
        
        return Result.success(order);
    }
}
```

**åº“å­˜æœåŠ¡ï¼ˆä¸‹æ¸¸ï¼‰ï¼š**

```java
@Service
public class StockService {
    
    public void deduct(String idemKey, List<Item> items) {
        // ä½¿ç”¨åŒä¸€ä¸ª idemKeyï¼Œä½† bizType ä¸åŒ
        executeWithIdempotent(idemKey, "DEDUCT_STOCK", items);
    }
}
```

**HTTP è°ƒç”¨ä¼ é€’å¹‚ç­‰é”®ï¼š**

```java
public void callDownstream(String idemKey, Object request) {
    HttpHeaders headers = new HttpHeaders();
    headers.set("X-Idempotent-Key", idemKey);
    
    HttpEntity<Object> entity = new HttpEntity<>(request, headers);
    restTemplate.exchange(url, HttpMethod.POST, entity, Result.class);
}
```

**RPC è°ƒç”¨ä¼ é€’å¹‚ç­‰é”®ï¼ˆDubboï¼‰ï¼š**

```java
// è°ƒç”¨æ–¹
RpcContext.getContext().setAttachment("idemKey", idemKey);
orderService.createOrder(request);

// æœåŠ¡æ–¹
String idemKey = RpcContext.getContext().getAttachment("idemKey");
executeWithIdempotent(idemKey, "CREATE_ORDER", request);
```

### MQ æ¶ˆè´¹å¹‚ç­‰

```java
@RabbitListener(queues = "order.queue")
public void consumeOrder(Message message, Channel channel, 
                         @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag) {
    String idemKey = message.getMessageProperties().getMessageId();
    String bizType = "MQ_CONSUME_ORDER";
    
    try {
        // å¹‚ç­‰æ£€æŸ¥ + æ‰§è¡Œä¸šåŠ¡
        OrderMessage orderMsg = JSON.parseObject(
            new String(message.getBody()), OrderMessage.class
        );
        
        executeWithIdempotent(idemKey, bizType, orderMsg);
        
        // ACK æ¶ˆæ¯
        channel.basicAck(deliveryTag, false);
        
    } catch (BizException e) {
        // ä¸šåŠ¡å¼‚å¸¸ï¼Œæ›´æ–°ä¸ºå¤±è´¥ + è¿›æ­»ä¿¡é˜Ÿåˆ—
        try {
            mapper.updateStatus(idemKey, bizType, 2, e.getMessage());
            channel.basicNack(deliveryTag, false, false);
        } catch (IOException ioEx) {
            log.error("ACK å¤±è´¥", ioEx);
        }
    } catch (Exception e) {
        // ç³»ç»Ÿå¼‚å¸¸ï¼Œé‡æ–°å…¥é˜Ÿ
        try {
            channel.basicNack(deliveryTag, false, true);
        } catch (IOException ioEx) {
            log.error("NACK å¤±è´¥", ioEx);
        }
    }
}
```

### è¡¥å¿ JOB

```java
@Component
public class IdempotentCompensateJob {
    
    @Autowired
    private IdempotentMapper mapper;
    
    @Scheduled(cron = "0 */10 * * * ?")
    public void compensate() {
        // æŸ¥åƒµå°¸è®°å½•ï¼ˆå¤„ç†ä¸­è¶…è¿‡ 10 åˆ†é’Ÿï¼‰
        LocalDateTime threshold = LocalDateTime.now().minusMinutes(10);
        List<IdempotentRecord> zombies = mapper.selectZombies(threshold);
        
        log.info("å‘ç°åƒµå°¸è®°å½•æ•°é‡: {}", zombies.size());
        
        for (IdempotentRecord record : zombies) {
            try {
                // æŸ¥ä¸šåŠ¡è¡¨ç¡®è®¤å®é™…ç»“æœ
                boolean bizSuccess = checkBizResult(record);
                
                if (bizSuccess) {
                    // ä¸šåŠ¡å·²æˆåŠŸï¼Œè¡¥å¿æ›´æ–°å¹‚ç­‰è¡¨
                    mapper.updateStatus(
                        record.getIdemKey(), 
                        record.getBizType(), 
                        1, 
                        "è¡¥å¿æ›´æ–°"
                    );
                    log.info("è¡¥å¿æˆåŠŸ: {}", record.getIdemKey());
                } else {
                    // ä¸šåŠ¡æœªæˆåŠŸï¼Œæ ‡è®°ä¸ºå¤±è´¥
                    mapper.updateStatus(
                        record.getIdemKey(), 
                        record.getBizType(), 
                        2, 
                        "è¶…æ—¶å¤±è´¥"
                    );
                    log.warn("è¡¥å¿å¤±è´¥: {}", record.getIdemKey());
                }
            } catch (Exception e) {
                log.error("è¡¥å¿å¼‚å¸¸: {}", record.getIdemKey(), e);
            }
        }
    }
    
    // æ ¹æ®ä¸šåŠ¡ç±»å‹æŸ¥è¯¢å®é™…æ‰§è¡Œç»“æœ
    private boolean checkBizResult(IdempotentRecord record) {
        String bizType = record.getBizType();
        String idemKey = record.getIdemKey();
        
        if ("CREATE_ORDER".equals(bizType)) {
            // æŸ¥è®¢å•è¡¨
            return orderMapper.existsByIdemKey(idemKey);
        } else if ("PAY".equals(bizType)) {
            // æŸ¥æ”¯ä»˜è¡¨
            return payMapper.existsByIdemKey(idemKey);
        }
        
        return false;
    }
}
```

### æ•°æ®æ¸…ç†

**å®šæ—¶ä»»åŠ¡ï¼š**

```java
@Component
public class IdempotentCleanupJob {
    
    @Autowired
    private IdempotentMapper mapper;
    
    @Scheduled(cron = "0 0 2 * * ?")
    public void cleanup() {
        LocalDateTime now = LocalDateTime.now();
        int deleted = mapper.deleteExpired(now);
        log.info("æ¸…ç†è¿‡æœŸå¹‚ç­‰è®°å½•: {} æ¡", deleted);
    }
}
```

**åˆ†åŒºè¡¨ï¼ˆæ¨èï¼‰ï¼š**

```sql
-- åˆ›å»ºåˆ†åŒºè¡¨
ALTER TABLE idempotent_record PARTITION BY RANGE (TO_DAYS(expire_at)) (
    PARTITION p202401 VALUES LESS THAN (TO_DAYS('2024-02-01')),
    PARTITION p202402 VALUES LESS THAN (TO_DAYS('2024-03-01')),
    PARTITION p202403 VALUES LESS THAN (TO_DAYS('2024-04-01')),
    PARTITION p202404 VALUES LESS THAN (TO_DAYS('2024-05-01')),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);

-- å®šæœŸ DROP æ—§åˆ†åŒºï¼ˆç§’çº§åˆ é™¤ï¼Œä¸å½±å“ä¸šåŠ¡ï¼‰
ALTER TABLE idempotent_record DROP PARTITION p202401;

-- æ·»åŠ æ–°åˆ†åŒº
ALTER TABLE idempotent_record REORGANIZE PARTITION p_future INTO (
    PARTITION p202405 VALUES LESS THAN (TO_DAYS('2024-06-01')),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

åˆ†åŒºè¡¨ä¼˜åŠ¿ï¼š
- DROP åˆ†åŒºç§’çº§å®Œæˆï¼Œä¸é”è¡¨
- é¿å…å¤§æ‰¹é‡ DELETE å¯¼è‡´çš„ä¸»ä»å»¶è¿Ÿ
- æŸ¥è¯¢æ€§èƒ½æ›´å¥½ï¼ˆåˆ†åŒºè£å‰ªï¼‰

## ç›‘æ§å‘Šè­¦

**ç›‘æ§æŒ‡æ ‡é‡‡é›†ï¼š**

```java
@Aspect
@Component
public class IdempotentMonitor {
    
    @Autowired
    private MeterRegistry meterRegistry;
    
    @Around("execution(* executeWithIdempotent(..))")
    public Object monitor(ProceedingJoinPoint pjp) throws Throwable {
        String bizType = (String) pjp.getArgs()[1];
        
        try {
            Object result = pjp.proceed();
            
            // è®°å½•æˆåŠŸ
            meterRegistry.counter("idempotent.execute", 
                "biz_type", bizType, 
                "result", "success"
            ).increment();
            
            return result;
            
        } catch (BizException e) {
            if (e.getMessage().contains("é‡å¤è¯·æ±‚")) {
                // å¹‚ç­‰å‘½ä¸­
                meterRegistry.counter("idempotent.hit", 
                    "biz_type", bizType
                ).increment();
            } else if (e.getMessage().contains("å‚æ•°å·²å˜æ›´")) {
                // payload å†²çª
                meterRegistry.counter("idempotent.payload_conflict", 
                    "biz_type", bizType
                ).increment();
            }
            throw e;
        }
    }
}
```

**ç›‘æ§æŒ‡æ ‡ï¼š**
- `idempotent.execute`ï¼šå¹‚ç­‰æ‰§è¡Œæ¬¡æ•°ï¼ˆæŒ‰ä¸šåŠ¡ç±»å‹ã€ç»“æœåˆ†ç»„ï¼‰
- `idempotent.hit`ï¼šå¹‚ç­‰å‘½ä¸­æ¬¡æ•°ï¼ˆé‡å¤è¯·æ±‚å æ¯”ï¼‰
- `idempotent.payload_conflict`ï¼šå‚æ•°å†²çªæ¬¡æ•°
- `idempotent.zombie_count`ï¼šåƒµå°¸è®°å½•æ•°é‡ï¼ˆè¡¥å¿ JOB ä¸ŠæŠ¥ï¼‰
- `idempotent.table_qps`ï¼šå¹‚ç­‰è¡¨å†™å…¥ QPS

**å‘Šè­¦è§„åˆ™ï¼š**

```yaml
# Prometheus å‘Šè­¦è§„åˆ™
groups:
  - name: idempotent_alerts
    rules:
      # åƒµå°¸è®°å½•å‘Šè­¦
      - alert: IdempotentZombieRecords
        expr: idempotent_zombie_count > 100
        for: 5m
        annotations:
          summary: "å¹‚ç­‰åƒµå°¸è®°å½•è¿‡å¤š"
          
      # å¹‚ç­‰å‘½ä¸­ç‡çªå¢
      - alert: IdempotentHitRateHigh
        expr: rate(idempotent_hit[5m]) > 0.5
        for: 5m
        annotations:
          summary: "å¹‚ç­‰å‘½ä¸­ç‡çªå¢ï¼Œå¯èƒ½æœ‰é‡è¯•é£æš´"
          
      # payload å†²çªå‘Šè­¦
      - alert: IdempotentPayloadConflict
        expr: rate(idempotent_payload_conflict[5m]) > 10
        for: 5m
        annotations:
          summary: "å¹‚ç­‰å‚æ•°å†²çªé¢‘ç¹ï¼Œå¯èƒ½æœ‰æ”»å‡»"
```

## å¸¸è§é—®é¢˜

**Redis å®•æœºæ€ä¹ˆåŠï¼Ÿ**

æ–¹æ¡ˆä¸€ï¼šé™çº§åˆ°æ•°æ®åº“å¹‚ç­‰
```java
try {
    redis.setNx(key, "1", 7, TimeUnit.DAYS);
} catch (RedisException e) {
    log.warn("Redis ä¸å¯ç”¨ï¼Œé™çº§åˆ°æ•°æ®åº“å¹‚ç­‰");
    // ç›´æ¥èµ°æ•°æ®åº“å¹‚ç­‰é€»è¾‘
}
```

æ–¹æ¡ˆäºŒï¼šæ‹’ç»è¯·æ±‚ï¼ˆèµ„é‡‘ç±»åœºæ™¯ï¼‰
```java
if (!redis.isAvailable()) {
    throw new BizException("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
}
```

**å¹‚ç­‰ ID è°æ¥ç”Ÿæˆï¼Ÿ**

å‰ç«¯ç”Ÿæˆï¼ˆæ¨èï¼‰ï¼š
```javascript
// å‰ç«¯ç”Ÿæˆ UUID
const idemKey = uuidv4();
axios.post('/api/order', data, {
    headers: { 'X-Idempotent-Key': idemKey }
});
```

åç«¯ç”Ÿæˆï¼š
```java
// ä¸šåŠ¡ ID + æ“ä½œç±»å‹
String idemKey = orderId + ":create";
```

**åˆ†åº“åˆ†è¡¨æ€ä¹ˆåšï¼Ÿ**

åˆ†ç‰‡ç­–ç•¥ï¼š
```java
// æ ¹æ® idem_key å“ˆå¸Œåˆ†ç‰‡
int shardIndex = Math.abs(idemKey.hashCode()) % 16;
String tableName = "idempotent_record_" + shardIndex;
```

è¡¥å¿ JOB éœ€è¦æ‰«æ‰€æœ‰åˆ†ç‰‡ï¼š
```java
for (int i = 0; i < 16; i++) {
    String tableName = "idempotent_record_" + i;
    List<IdempotentRecord> zombies = mapper.selectZombies(tableName, threshold);
    // å¤„ç†åƒµå°¸è®°å½•
}
```

**å¦‚ä½•æ”¯æŒå¤šæ•°æ®æºï¼Ÿ**

æ¯ä¸ªæ•°æ®æºç‹¬ç«‹å¹‚ç­‰è¡¨ï¼š
```java
@DS("order_db")
public void createOrder(String idemKey) {
    // ä½¿ç”¨ order_db çš„å¹‚ç­‰è¡¨
}

@DS("pay_db")
public void pay(String idemKey) {
    // ä½¿ç”¨ pay_db çš„å¹‚ç­‰è¡¨
}
```
