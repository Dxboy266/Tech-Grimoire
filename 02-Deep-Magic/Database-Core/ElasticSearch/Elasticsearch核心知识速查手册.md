# Elasticsearch æ ¸å¿ƒçŸ¥è¯†é€ŸæŸ¥æ‰‹å†Œ

> **5åˆ†é’Ÿå¿«é€Ÿä¸Šæ‰‹ | 30åˆ†é’Ÿæ·±å…¥ç†è§£ | åŸºäºçœŸå®ç”Ÿäº§é¡¹ç›®**

---

## ğŸ“Œ å¿«é€Ÿå¯¼èˆª

**æ–°æ‰‹ï¼ˆ5åˆ†é’Ÿï¼‰**ï¼šçœ‹ [ä¸€ã€å¿«é€Ÿä¸Šæ‰‹](#ä¸€å¿«é€Ÿä¸Šæ‰‹)  
**è¿›é˜¶ï¼ˆ30åˆ†é’Ÿï¼‰**ï¼šçœ‹ [äºŒã€æ ¸å¿ƒåŸç†](#äºŒæ ¸å¿ƒåŸç†) + [ä¸‰ã€ç”Ÿäº§å®è·µ](#ä¸‰ç”Ÿäº§å®è·µ)  
**é¢è¯•ï¼ˆ1å°æ—¶ï¼‰**ï¼šçœ‹ [å››ã€é«˜é¢‘é¢è¯•é¢˜](#å››é«˜é¢‘é¢è¯•é¢˜) + [äº”ã€è¸©å‘è®°å½•](#äº”è¸©å‘è®°å½•)

---

## ä¸€ã€å¿«é€Ÿä¸Šæ‰‹ï¼ˆ5åˆ†é’Ÿï¼‰

### 1.1 ES æ˜¯ä»€ä¹ˆï¼Ÿ

**ä¸€å¥è¯ï¼š** åˆ†å¸ƒå¼æœç´¢å¼•æ“ï¼Œç”¨äºå…¨æ–‡æ£€ç´¢å’Œæ•°æ®åˆ†æã€‚

**ç±»æ¯”ï¼š**
- MySQL = å›¾ä¹¦é¦†çš„ä¹¦æ¶ï¼ˆæŒ‰ä¹¦å·æŸ¥æ‰¾ï¼‰
- ES = å›¾ä¹¦é¦†çš„ç´¢å¼•å¡ç‰‡ï¼ˆæŒ‰å…³é”®è¯æŸ¥æ‰¾ï¼‰

### 1.2 æœ€ç®€å•çš„ä¾‹å­

```java
// 1. å®šä¹‰ç´¢å¼•å®ä½“
@Document(indexName = "user")
public class UserESO {
    @Id
    private String id;
    
    @Field(type = FieldType.Text, analyzer = "ik_smart")
    private String name; // æ”¯æŒä¸­æ–‡åˆ†è¯æœç´¢
    
    @Field(type = FieldType.Keyword)
    private String phone; // ç²¾ç¡®åŒ¹é…
}

// 2. å®šä¹‰ Repository
public interface UserRepository extends ElasticsearchRepository<UserESO, String> {
}

// 3. ä½¿ç”¨
@Autowired
private UserRepository userRepository;

// ä¿å­˜
userRepository.save(new UserESO("1", "å¼ ä¸‰", "13812345678"));

// æœç´¢
List<UserESO> users = userRepository.findByName("å¼ ä¸‰");
```

**å°±è¿™ä¹ˆç®€å•ï¼** 90% çš„åœºæ™¯ç”¨è¿™ä¸ªå°±å¤Ÿäº†ã€‚

---

## äºŒã€æ ¸å¿ƒåŸç†ï¼ˆ30åˆ†é’Ÿï¼‰

### 2.1 å€’æ’ç´¢å¼•åŸç†

**æ­£æ’ç´¢å¼•ï¼ˆMySQLï¼‰ï¼š**
```text
DocID â†’ Content
1     â†’ "å¼ ä¸‰æƒ³ä¹°æ–°èƒ½æºæ±½è½¦"
2     â†’ "æå››æƒ³ä¹°ç‡ƒæ²¹æ±½è½¦"

æŸ¥è¯¢ "æ–°èƒ½æº"ï¼šå…¨è¡¨æ‰«æï¼ŒO(N)
```

**å€’æ’ç´¢å¼•ï¼ˆESï¼‰ï¼š**
```text
Term    â†’ DocID List
å¼ ä¸‰    â†’ [1]
æå››    â†’ [2]
æ–°èƒ½æº  â†’ [1]
æ±½è½¦    â†’ [1, 2]

æŸ¥è¯¢ "æ–°èƒ½æº"ï¼šç›´æ¥å®šä½åˆ° [1]ï¼ŒO(1)
```

**è¿™å°±æ˜¯ ES å¿«çš„åŸå› ï¼**

### 2.2 å­—æ®µç±»å‹é€‰æ‹©

| å­—æ®µç±»å‹ | æ˜¯å¦åˆ†è¯ | æ˜¯å¦èšåˆ | é€‚ç”¨åœºæ™¯ | é¡¹ç›®å®è·µ |
|---------|---------|---------|---------|---------|
| **Keyword** | âŒ | âœ… | IDã€çŠ¶æ€ç  | custIdã€statusCode |
| **Text** | âœ… | âŒ | å…¨æ–‡æ£€ç´¢ | custNameã€content |
| **Date** | âŒ | âœ… | æ—¶é—´èŒƒå›´æŸ¥è¯¢ | createdDate |
| **Nested** | - | - | ä¸€å¯¹å¤šå…³ç³» | custResumeList |

**å…³é”®ï¼š**
- éœ€è¦æœç´¢ â†’ Text
- éœ€è¦èšåˆ/æ’åº â†’ Keyword
- ä¸¤è€…éƒ½éœ€è¦ â†’ MultiField

### 2.3 åˆ†è¯å™¨é€‰æ‹©

| åˆ†è¯å™¨ | åˆ†è¯ç²’åº¦ | é€‚ç”¨åœºæ™¯ | é¡¹ç›®å®è·µ |
|-------|---------|---------|---------|
| **ik_smart** | ç²—ç²’åº¦ | æ ‡é¢˜ã€åç§° | custName |
| **ik_max_word** | ç»†ç²’åº¦ | æ­£æ–‡ã€è¯¦æƒ… | content |
| **ngram** | è‡ªå®šä¹‰ | æ‰‹æœºå·æ¨¡ç³Šæœç´¢ | phone.ngram |
| **keyword** | ä¸åˆ†è¯ | ç²¾ç¡®åŒ¹é… | statusCode |

**ç¤ºä¾‹ï¼š**
```text
è¾“å…¥ï¼šå¼ ä¸‰æƒ³ä¹°æ–°èƒ½æºæ±½è½¦

ik_smartï¼š  å¼ ä¸‰ / æƒ³ä¹° / æ–°èƒ½æº / æ±½è½¦
ik_max_wordï¼šå¼ ä¸‰ / æƒ³ / ä¹° / æ–°èƒ½æº / æ–°èƒ½ / èƒ½æº / æ±½è½¦
```

---

## ä¸‰ã€ç”Ÿäº§å®è·µï¼ˆ30åˆ†é’Ÿï¼‰

### 3.1 çœŸå®æ¡ˆä¾‹ï¼šæ‰‹æœºå·ä»»æ„ä½ç½®æœç´¢

**éœ€æ±‚ï¼š** æœç´¢ "1381" èƒ½åŒ¹é…åˆ° "13812345678"ï¼Œæœç´¢ "5678" ä¹Ÿèƒ½åŒ¹é…ã€‚

**æ–¹æ¡ˆå¯¹æ¯”ï¼š**

| æ–¹æ¡ˆ | æ€§èƒ½ | å®ç°éš¾åº¦ | ç¼ºç‚¹ |
|------|------|---------|------|
| **wildcard** | å·® | ç®€å• | æ— æ³•ä½¿ç”¨ç´¢å¼• |
| **ngram** | å¥½ | ä¸­ç­‰ | ç´¢å¼•ä½“ç§¯å¤§ |

**æœ€ç»ˆæ–¹æ¡ˆï¼šNGram åˆ†è¯å™¨**

```java
// 1. é…ç½® NGram åˆ†è¯å™¨ï¼ˆes-settings.jsonï¼‰
{
  "analysis": {
    "tokenizer": {
      "phone_ngram_tokenizer": {
        "type": "ngram",
        "min_gram": 4,  // æœ€å°åˆ†è¯é•¿åº¦
        "max_gram": 11, // æœ€å¤§åˆ†è¯é•¿åº¦ï¼ˆæ‰‹æœºå·11ä½ï¼‰
        "token_chars": ["digit"]
      }
    }
  }
}

// 2. å®šä¹‰ MultiField
@MultiField(
    mainField = @Field(type = FieldType.Keyword),  // ç²¾ç¡®åŒ¹é…
    otherFields = {
        @InnerField(suffix = "ngram", type = FieldType.Text, 
                   analyzer = "phone_ngram_analyzer")  // æ¨¡ç³Šæœç´¢
    }
)
private String phone;

// 3. æŸ¥è¯¢
boolQueryBuilder.should(QueryBuilders.termQuery("phone", "13812345678").boost(10.0f))        // ç²¾ç¡®ï¼šæƒé‡10
                .should(QueryBuilders.matchQuery("phone.ngram", "1381").boost(1.0f));        // æ¨¡ç³Šï¼šæƒé‡1
```

**å…³é”®æ•°æ®ï¼š**
- ç´¢å¼•ä½“ç§¯ï¼šå¢åŠ 30%ï¼ˆå¯æ¥å—ï¼‰
- æŸ¥è¯¢æ€§èƒ½ï¼š10msï¼ˆä¼˜äº wildcard çš„ 100msï¼‰
- ç”¨æˆ·ä½“éªŒï¼šæ”¯æŒä»»æ„ä½ç½®æœç´¢

### 3.2 çœŸå®æ¡ˆä¾‹ï¼šè·Ÿè¿›å±¥å†æœç´¢

**éœ€æ±‚ï¼š** æœç´¢è·Ÿè¿›å±¥å†å†…å®¹ï¼Œé«˜äº®åŒ¹é…çš„å±¥å†ã€‚

**é—®é¢˜ï¼š** ä¸€ä¸ªçº¿ç´¢æœ‰å¤šæ¡å±¥å†ï¼Œå¦‚ä½•åªè¿”å›åŒ¹é…çš„å±¥å†ï¼Ÿ

**æ–¹æ¡ˆï¼šNested åµŒå¥—æ–‡æ¡£**

```java
// 1. å®šä¹‰ Nested å­—æ®µ
@Field(type = FieldType.Nested)
private List<CustResumeESO> custResumeList;

// 2. Nested æŸ¥è¯¢
QueryBuilders.nestedQuery(
    "custResumeList",
    QueryBuilders.boolQuery()
        .should(QueryBuilders.matchPhraseQuery("custResumeList.content", "æ–°èƒ½æº").boost(5.0f))  // çŸ­è¯­ï¼šæƒé‡é«˜
        .should(QueryBuilders.matchQuery("custResumeList.content", "æ–°èƒ½æº").boost(1.0f)),       // åˆ†è¯ï¼šæƒé‡ä½
    ScoreMode.Max
).innerHit(
    new InnerHitBuilder("resume_inner_hit")
        .setSize(10)
        .setHighlightBuilder(
            new HighlightBuilder()
                .field("custResumeList.content")
                .preTags("<em class='highlight'>")
                .postTags("</em>")
        )
);

// 3. å¤„ç†ç»“æœ
Map<String, SearchHits> innerHits = hit.getInnerHits();
SearchHits resumeHits = innerHits.get("resume_inner_hit");
for (SearchHit resumeHit : resumeHits.getHits()) {
    // è·å–é«˜äº®å†…å®¹
    String highlightText = resumeHit.getHighlightFields()
                                   .get("custResumeList.content")
                                   .fragments()[0]
                                   .string();
}
```

**å…³é”®ï¼š** Nested ä¿è¯æŸ¥è¯¢æ¡ä»¶åœ¨åŒä¸€ä¸ªå­å¯¹è±¡å†…åŒ¹é…ã€‚

### 3.3 çœŸå®æ¡ˆä¾‹ï¼šæ·±åˆ†é¡µä¼˜åŒ–

**é—®é¢˜ï¼š** æŸ¥è¯¢ç¬¬1000é¡µæ—¶ï¼Œæ€§èƒ½æ€¥å‰§ä¸‹é™ã€‚

**åŸå› ï¼š**
```text
from/size æ–¹æ¡ˆï¼š
- from = 20000, size = 20
- æ¯ä¸ªåˆ†ç‰‡æŸ¥è¯¢å‰ 20020 æ¡
- 5ä¸ªåˆ†ç‰‡ = 100100 æ¡æ•°æ®åŠ è½½åˆ°å†…å­˜
- åè°ƒèŠ‚ç‚¹æ’åºåå– 20000-20020
- æ€§èƒ½éšé¡µç å¢åŠ çº¿æ€§ä¸‹é™
```

**è§£å†³æ–¹æ¡ˆï¼šsearch_after**

```java
// ç¬¬ä¸€é¡µ
SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();
searchSourceBuilder.sort("lastReviewTime", SortOrder.DESC)
                   .sort("clueId", SortOrder.DESC)  // å”¯ä¸€å­—æ®µä½œä¸º tiebreaker
                   .size(20);

SearchResponse response1 = esClient.search(request, RequestOptions.DEFAULT);
Object[] lastSort = response1.getHits().getHits()[19].getSortValues();

// ç¬¬äºŒé¡µ
searchSourceBuilder.searchAfter(lastSort);
SearchResponse response2 = esClient.search(request, RequestOptions.DEFAULT);
```

**å…³é”®æ•°æ®ï¼š**
- from/sizeï¼ˆç¬¬1000é¡µï¼‰ï¼šRT=2000ms
- search_afterï¼ˆç¬¬1000é¡µï¼‰ï¼šRT=50ms
- **æ€§èƒ½æå‡ï¼š40å€**

---

## å››ã€é«˜é¢‘é¢è¯•é¢˜ï¼ˆ1å°æ—¶ï¼‰

### 4.1 å­—èŠ‚è·³åŠ¨ï¼šES ä¸ºä»€ä¹ˆå¿«ï¼Ÿ

**âŒ é”™è¯¯å›ç­”ï¼š**
> å› ä¸ºç”¨äº†å€’æ’ç´¢å¼•ã€‚

**âœ… æ­£ç¡®å›ç­”ï¼š**
> 1. **å€’æ’ç´¢å¼•**ï¼šTerm â†’ DocID Listï¼ŒO(1) æŸ¥æ‰¾
> 2. **åˆ†è¯å™¨**ï¼šä¸­æ–‡åˆ†è¯ï¼ˆIKï¼‰ã€NGramï¼ˆæ‰‹æœºå·ï¼‰
> 3. **åˆ†ç‰‡å¹¶è¡Œ**ï¼š5ä¸ªåˆ†ç‰‡å¹¶è¡ŒæŸ¥è¯¢ï¼Œæ€§èƒ½æå‡5å€
> 4. **ç¼“å­˜**ï¼šfilter æŸ¥è¯¢ç»“æœç¼“å­˜
> 
> æˆ‘ä»¬é¡¹ç›®ä¸­ï¼š
> - 100ä¸‡æ¡çº¿ç´¢æ•°æ®
> - 5ä¸ªåˆ†ç‰‡
> - æŸ¥è¯¢è€—æ—¶ï¼š10-50ms
> - QPSï¼š1000+

**å…³é”®ï¼šæœ‰æ•°æ®æ”¯æ’‘ï¼**

### 4.2 é˜¿é‡Œå·´å·´ï¼šæ·±åˆ†é¡µé—®é¢˜å¦‚ä½•è§£å†³ï¼Ÿ

**âŒ é”™è¯¯å›ç­”ï¼š**
> ç”¨ scroll æˆ– search_afterã€‚

**âœ… æ­£ç¡®å›ç­”ï¼š**
> 1. **é—®é¢˜**ï¼šfrom/size æ·±åˆ†é¡µå¯¼è‡´å†…å­˜å ç”¨å¤§ã€æ€§èƒ½å·®
> 2. **åŸå› **ï¼šåè°ƒèŠ‚ç‚¹éœ€è¦æ±‡æ€»æ‰€æœ‰åˆ†ç‰‡çš„æ•°æ®
> 3. **æ–¹æ¡ˆå¯¹æ¯”**ï¼š
>    - from/sizeï¼šæ”¯æŒè·³é¡µï¼Œä½†æ·±åˆ†é¡µæ€§èƒ½å·®
>    - scrollï¼šå·²åºŸå¼ƒï¼Œå ç”¨å†…å­˜å¤§
>    - search_afterï¼šæ€§èƒ½ç¨³å®šï¼Œä½†ä¸æ”¯æŒè·³é¡µ
> 4. **é¡¹ç›®å®è·µ**ï¼š
>    - å‰ç«¯ï¼šæ»šåŠ¨åŠ è½½ä»£æ›¿åˆ†é¡µ
>    - åç«¯ï¼šsearch_after + lastReviewTime æ’åº
>    - æ€§èƒ½ï¼šç¬¬1000é¡µä» 2000ms é™åˆ° 50ms
> 
> æˆ‘ä»¬é‡åˆ°è¿‡ä¸€æ¬¡æ·±åˆ†é¡µå¯¼è‡´OOMï¼Œæ’æŸ¥è¿‡ç¨‹ï¼š
> - ç›‘æ§å‘ç° ES å†…å­˜å ç”¨é«˜
> - æ…¢æŸ¥è¯¢æ—¥å¿—å‘ç°å¤§é‡ from=10000 çš„æŸ¥è¯¢
> - ä¼˜åŒ–ä¸º search_after åï¼Œå†…å­˜å ç”¨é™ä½80%

**å…³é”®ï¼šæœ‰å®æˆ˜ç»éªŒï¼**

### 4.3 æ‹¼å¤šå¤šï¼šNested å’Œ Object çš„åŒºåˆ«ï¼Ÿ

**é—®é¢˜ï¼š** ä»€ä¹ˆæ—¶å€™ç”¨ Nestedï¼Ÿ

**âŒ é”™è¯¯å›ç­”ï¼š**
> ä¸€å¯¹å¤šå…³ç³»ç”¨ Nestedã€‚

**âœ… æ­£ç¡®å›ç­”ï¼š**
> 1. **Object é—®é¢˜**ï¼šES ä¼šå°†æ•°ç»„æ‰å¹³åŒ–ï¼Œå¯¼è‡´æŸ¥è¯¢ç»“æœé”™è¯¯
> 2. **Nested è§£å†³**ï¼šES å†…éƒ¨å­˜å‚¨ä¸ºç‹¬ç«‹çš„éšè—æ–‡æ¡£ï¼Œä¿è¯æŸ¥è¯¢æ­£ç¡®æ€§
> 3. **ä½¿ç”¨åœºæ™¯**ï¼š
>    - âœ… éœ€è¦åœ¨åŒä¸€ä¸ªå­å¯¹è±¡å†…åŒ¹é…å¤šä¸ªæ¡ä»¶
>    - âŒ ç®€å•æ•°ç»„ï¼ˆæ ‡ç­¾åˆ—è¡¨ï¼‰
>    - âŒ æ•°æ®é‡å¤§ï¼ˆNested å ç”¨æ›´å¤šèµ„æºï¼‰
> 4. **é¡¹ç›®å®è·µ**ï¼š
>    - çº¿ç´¢ â†’ è·Ÿè¿›å±¥å†ï¼ˆä¸€å¯¹å¤šï¼‰
>    - æœç´¢ï¼šcontent="æ–°èƒ½æº" AND heat="é«˜"
>    - Object ä¼šåŒ¹é…é”™è¯¯ï¼ŒNested ä¿è¯æ­£ç¡®
> 
> æˆ‘ä»¬é‡åˆ°è¿‡ä¸€æ¬¡ Nested æ€§èƒ½é—®é¢˜ï¼š
> - å•ä¸ªçº¿ç´¢æœ‰100+æ¡å±¥å†
> - Nested æŸ¥è¯¢è€—æ—¶ 500ms
> - ä¼˜åŒ–ï¼šé™åˆ¶è¿”å›å±¥å†æ•°é‡ï¼ˆInnerHits.setSize(10)ï¼‰
> - ä¼˜åŒ–åï¼šè€—æ—¶é™åˆ° 50ms

**å…³é”®ï¼šçŸ¥é“ä¼˜ç¼ºç‚¹ï¼Œæœ‰ä¼˜åŒ–ç»éªŒï¼**

---

## äº”ã€è¸©å‘è®°å½•ï¼ˆè¡€æ³ªå²ï¼‰

### 5.1 å‘1ï¼šæ‰¹é‡å†™å…¥å¯¼è‡´ ES é›†ç¾¤å´©æºƒ

**ç°è±¡ï¼š** å…¨é‡åˆå§‹åŒ–100ä¸‡æ¡æ•°æ®æ—¶ï¼ŒES é›†ç¾¤å“åº”å˜æ…¢ï¼Œæœ€ç»ˆå´©æºƒã€‚

**åŸå› ï¼š** æ‰¹é‡å¤§å°è®¾ç½®ä¸å½“ï¼Œå•æ¬¡å†™å…¥10ä¸‡æ¡æ•°æ®ã€‚

**æ’æŸ¥è¿‡ç¨‹ï¼š**
1. ES ç›‘æ§å‘ç° CPU 100%ï¼Œå†…å­˜å ç”¨é«˜
2. æ…¢æŸ¥è¯¢æ—¥å¿—å‘ç°å¤§é‡ bulk è¯·æ±‚
3. æŸ¥çœ‹ä»£ç ï¼š`bulkRequest.add()` å¾ªç¯10ä¸‡æ¬¡
4. é—®é¢˜ï¼šå•æ¬¡è¯·æ±‚è¿‡å¤§ï¼ŒES æ— æ³•å¤„ç†

**è§£å†³æ–¹æ¡ˆï¼š**
```java
// ä¼˜åŒ–å‰
BulkRequest bulkRequest = new BulkRequest();
for (int i = 0; i < 100000; i++) {
    bulkRequest.add(new UpdateRequest(index, id).doc(data));
}
esClient.bulk(bulkRequest, RequestOptions.DEFAULT); // âŒ å•æ¬¡10ä¸‡æ¡

// ä¼˜åŒ–å
for (List<Data> batch : Lists.partition(dataList, 1000)) { // âœ… åˆ†æ‰¹1000æ¡
    BulkRequest bulkRequest = new BulkRequest();
    for (Data data : batch) {
        bulkRequest.add(new UpdateRequest(index, data.getId()).doc(data.toMap()));
    }
    esClient.bulk(bulkRequest, RequestOptions.DEFAULT);
}
```

**å…³é”®æ•°æ®ï¼š**
- ä¼˜åŒ–å‰ï¼š10ä¸‡æ¡/æ‰¹ï¼Œè€—æ—¶30sï¼ŒES CPU 100%
- ä¼˜åŒ–åï¼š1000æ¡/æ‰¹ï¼Œè€—æ—¶5sï¼ŒES CPU 30%
- **æ€§èƒ½æå‡ï¼š6å€**

**æ•™è®­ï¼š** æ‰¹é‡å¤§å° = 1000-5000æ¡ï¼Œæ ¹æ®æ–‡æ¡£å¤§å°è°ƒæ•´ã€‚

### 5.2 å‘2ï¼šNGram åˆ†è¯å™¨å¯¼è‡´ç´¢å¼•ä½“ç§¯æš´å¢

**ç°è±¡ï¼š** ç´¢å¼•ä½“ç§¯ä» 1GB å¢é•¿åˆ° 5GBã€‚

**åŸå› ï¼š** NGram åˆ†è¯å™¨é…ç½®ä¸å½“ï¼Œmin_gram=1, max_gram=20ã€‚

**æ’æŸ¥è¿‡ç¨‹ï¼š**
1. ç›‘æ§å‘ç°ç´¢å¼•ä½“ç§¯å¼‚å¸¸å¢é•¿
2. æŸ¥çœ‹ mappingï¼šphone å­—æ®µç”¨äº† ngram
3. æŸ¥çœ‹é…ç½®ï¼šmin_gram=1, max_gram=20
4. è®¡ç®—ï¼šæ‰‹æœºå·11ä½ï¼Œç”Ÿæˆ (1+20)Ã—20/2 = 210 ä¸ª token

**è§£å†³æ–¹æ¡ˆï¼š**
```json
// ä¼˜åŒ–å‰
{
  "min_gram": 1,  // âŒ å¤ªå°
  "max_gram": 20  // âŒ å¤ªå¤§
}

// ä¼˜åŒ–å
{
  "min_gram": 4,  // âœ… æœ€å°4ä½ï¼ˆç”¨æˆ·ä¸€èˆ¬æœç´¢4ä½ä»¥ä¸Šï¼‰
  "max_gram": 11  // âœ… æœ€å¤§11ä½ï¼ˆæ‰‹æœºå·é•¿åº¦ï¼‰
}
```

**å…³é”®æ•°æ®ï¼š**
- ä¼˜åŒ–å‰ï¼šç´¢å¼•ä½“ç§¯ 5GBï¼Œtoken æ•°é‡ 210ä¸ª/æ‰‹æœºå·
- ä¼˜åŒ–åï¼šç´¢å¼•ä½“ç§¯ 1.5GBï¼Œtoken æ•°é‡ 36ä¸ª/æ‰‹æœºå·
- **ä½“ç§¯å‡å°‘ï¼š70%**

**æ•™è®­ï¼š** NGram å‚æ•°è¦æ ¹æ®å®é™…éœ€æ±‚è®¾ç½®ï¼Œä¸è¦ç›²ç›®è®¾ç½®ã€‚

### 5.3 å‘3ï¼šNested æŸ¥è¯¢æ€§èƒ½å·®

**ç°è±¡ï¼š** è·Ÿè¿›å±¥å†æœç´¢è€—æ—¶ 500msï¼Œè¿œè¶…é¢„æœŸã€‚

**åŸå› ï¼š** å•ä¸ªçº¿ç´¢æœ‰100+æ¡å±¥å†ï¼ŒNested æŸ¥è¯¢éœ€è¦éå†æ‰€æœ‰å±¥å†ã€‚

**æ’æŸ¥è¿‡ç¨‹ï¼š**
1. æ…¢æŸ¥è¯¢æ—¥å¿—å‘ç° Nested æŸ¥è¯¢è€—æ—¶é•¿
2. æŸ¥çœ‹æ•°æ®ï¼šéƒ¨åˆ†çº¿ç´¢æœ‰100+æ¡å±¥å†
3. åˆ†æï¼šNested æŸ¥è¯¢éœ€è¦éå†æ‰€æœ‰å±¥å†ï¼Œæ€§èƒ½å·®

**è§£å†³æ–¹æ¡ˆï¼š**
```java
// ä¼˜åŒ–å‰
InnerHitBuilder innerHitBuilder = new InnerHitBuilder("resume_inner_hit")
    .setSize(100); // âŒ è¿”å›æ‰€æœ‰å±¥å†

// ä¼˜åŒ–å
InnerHitBuilder innerHitBuilder = new InnerHitBuilder("resume_inner_hit")
    .setSize(10); // âœ… åªè¿”å›å‰10æ¡

// ä¸šåŠ¡ä¼˜åŒ–ï¼šåªä¿ç•™æœ€è¿‘30å¤©çš„å±¥å†åˆ° ES
```

**å…³é”®æ•°æ®ï¼š**
- ä¼˜åŒ–å‰ï¼šå¹³å‡è€—æ—¶ 500ms
- ä¼˜åŒ–åï¼šå¹³å‡è€—æ—¶ 50ms
- **æ€§èƒ½æå‡ï¼š10å€**

**æ•™è®­ï¼š** Nested æ–‡æ¡£æ•°é‡è¦æ§åˆ¶ï¼Œä¸è¦æ— é™å¢é•¿ã€‚

---

## å…­ã€æ€»ç»“

### æ ¸å¿ƒåŸåˆ™

1. **æ•°æ®ç»“æ„ä¼˜å…ˆ**ï¼šå€’æ’ç´¢å¼• + åˆ†è¯å™¨ = ES çš„æ ¸å¿ƒ
2. **æ¶ˆé™¤ç‰¹æ®Šæƒ…å†µ**ï¼šç»Ÿä¸€ä½¿ç”¨ search_afterï¼Œä¸è¦ from/size
3. **å®ç”¨ä¸»ä¹‰**ï¼šNGram ç´¢å¼•ä½“ç§¯å¤§ï¼Œä½†æœç´¢ä½“éªŒå¥½

### å¿«é€Ÿæ£€æŸ¥æ¸…å•

- âœ… å­—æ®µç±»å‹æ˜¯å¦é€‰å¯¹ï¼Ÿï¼ˆKeyword vs Textï¼‰
- âœ… åˆ†è¯å™¨æ˜¯å¦é€‰å¯¹ï¼Ÿï¼ˆik_smart vs ik_max_wordï¼‰
- âœ… æ‰¹é‡å¤§å°æ˜¯å¦åˆç†ï¼Ÿï¼ˆ1000-5000æ¡ï¼‰
- âœ… æ˜¯å¦æœ‰æ·±åˆ†é¡µï¼Ÿï¼ˆç”¨ search_afterï¼‰
- âœ… Nested æ–‡æ¡£æ•°é‡æ˜¯å¦å¯æ§ï¼Ÿï¼ˆ<100æ¡ï¼‰

---

**"Talk is cheap. Show me the code."**

